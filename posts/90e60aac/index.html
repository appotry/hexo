<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="docker, shell, linux"><meta name="description" content="通过一系列的实验使用户对docker的底层技术，如Namespace、CGroups、rootfs、联合加载等有一个感性的认识。在此过程中，我们还将通过Shell脚本一步一步地实现一个简易的docker，以期使读者在使用docker的过程中知其然知其所以然。"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="夜法之书"><meta name="theme-color" content="#7e9fc4"><meta name="msapplication-TileImage" content="/medias_webp/icons/android-chrome-192x192.png"><meta name="msapplication-TileColor" content="#7e9fc4"><meta http-equiv="Content-Security-Policy" content="default-src * vitals.vercel-insights.com 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; font-src * data: blob: 'unsafe-inline'; frame-src *;style-src * 'unsafe-inline';"><link rel="apple-touch-icon" href="/medias_webp/icons/apple-touch-icon.webp"><meta name="referrer" content="no-referrer-when-downgrade"><title>使用 Shell 脚本实现一个简单 Docker | 夜法之书</title><link rel="manifest" href="/manifest.json"><link rel="icon" type="image/png" href="/favicon.webp"><link href="//cdn.jsdelivr.net" rel="preconnect" crossorigin><link href="//lib.baomitu.com" rel="preconnect" crossorigin><link href="//busuanzi.ibruce.info" rel="preconnect" crossorigin><link href="//busuanzi.ibruce.info" rel="dns-prefetch" crossorigin><link href="//cimg1.17lai.site" rel="preconnect" crossorigin><link href="https://hm.baidu.com" rel="preconnect" crossorigin><link href="https://www.googletagmanager.com" rel="preconnect" crossorigin><link href="https://www.google-analytics.com" rel="preconnect" crossorigin><link href="//cdn.webpushr.com" rel="preconnect" crossorigin><link href="//bot.webpushr.com" rel="preconnect" crossorigin><link href="//analytics.webpushr.com" rel="preconnect" crossorigin><link href="https://waline.17lai.site" rel="preconnect" crossorigin><link href="https://waline.17lai.site" rel="dns-prefetch" crossorigin><link rel="alternate" type="application/atom+xml" title="所有订阅ATOM--夜法之书" href="https://blog.17lai.site/atom.xml"><link rel="alternate" type="application/rss+xml" title="所有订阅RSS2--夜法之书" href="https://blog.17lai.site/rss.xml"><link rel="alternate" type="application/json" title="所有订阅JSON--夜法之书" href="https://blog.17lai.site/feed.json"><style>.lazy-background{background-image:var(--background-img);background-repeat:no-repeat;background-size:cover;background-attachment:fixed}@media only screen and (max-width:1024px){.lazy-background{background-image:none}}</style><link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js" as="script" importance="high"><link rel="preload" href="/js/utils.js" as="script" importance="high"><link rel="preload" href="/js/color-schema.js" as="script" importance="high"><link rel="stylesheet preload" as="style" type="text/css" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"><link rel="preload" as="font" type="font/woff2" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/webfonts/fa-brands-400.woff2" crossorigin><link rel="preload" as="font" type="font/woff2" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/webfonts/fa-regular-400.woff2" crossorigin><link rel="preload" as="font" type="font/woff2" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/webfonts/fa-solid-900.woff2" crossorigin><link rel="stylesheet preload" as="style" type="text/css" href="/css/reward.css"><link rel="stylesheet preload" as="style" type="text/css" href="/libs/materialize/materialize.min.css"><link rel="stylesheet preload" as="style" type="text/css" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.min.css"><link rel="stylesheet preload" as="style" type="text/css" href="https://cdn.jsdelivr.net/npm/animate.css@3.6.1/animate.min.css"><link rel="stylesheet preload" as="style" type="text/css" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet preload" as="style" type="text/css" href="https://cdn.jsdelivr.net/npm/jquery-ui@1.13.2/dist/themes/base/jquery-ui.min.css"><link rel="stylesheet preload" as="style" type="text/css" href="/css/matery.css"><link rel="stylesheet preload" as="style" type="text/css" href="/css/my.css"><link rel="stylesheet" href="/libs/materialize/materialize.min.css"><link rel="stylesheet" href="/css/matery.css"><link rel="stylesheet" href="/css/my.css"><link rel="stylesheet preload" as="style" type="text/css" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><style>#artDetail{margin-top:-60px}@media only screen and (max-width:550px){#articleContent table{table-layout:fixed}}@media only screen and (min-width:1418px){#artDetail{margin-top:-60px;padding:0 .75rem}}#artDetail .card{box-shadow:0 10px 35px 2px rgba(0,0,0,.15),0 5px 15px rgba(0,0,0,.07),0 2px 5px -5px rgba(0,0,0,.1)!important}#artDetail .tag-cate{padding-bottom:15px}#artDetail a{margin-right:0!important;text-transform:none!important}#artDetail .article-info{padding:20px 30px 1px 40px;margin-bottom:-5px}#artDetail .article-tag .chip,#artDetail .tag_share .article-tag .chip{font-size:1rem;font-weight:400;height:25px;line-height:24px;color:var(--navbar-text-color);border-radius:15px;margin-right:5px;margin-bottom:2px;border:1px solid}#artDetail .post-cate{float:right;color:var(--post-link-color)}#artDetail .post-cate a{padding-right:5px;color:var(--post-link-color);font-weight:500}#artDetail .post-cate a:hover{text-decoration:underline}#artDetail .post-info{color:#525f7f}#artDetail .post-info .post-category{padding-right:4px;color:#525f7f}#artDetail .post-info .post-category:hover{font-weight:700;color:var(--post-link-color);text-decoration:underline}#artDetail .post-info .post-date{color:#525f7f}#artDetail .post-info .post-word-count{margin-left:15px}#artDetail .post-info .post-read{margin-left:15px;color:#525f7f}#artDetail .article-card-content{padding:0 15px 20px 18px}@media only screen and (max-width:601px){#artDetail .article-info{padding:15px 15px 1px 15px;margin-bottom:-5px}}@media only screen and (min-width:600px) and (max-width:992px){#artDetail .article-card-content{padding:0 30px 20px 32px}#artDetail .article-info{padding:15px 20px 0 28px;margin-bottom:-5px}}@media only screen and (min-width:993px){#artDetail .article-card-content{padding:0 50px 20px 50px}}#artDetail .reprint{margin:15px 0 .4rem;padding:.5rem .8rem;border:1px solid #eee;line-height:2;transition:box-shadow .3s ease-in-out}#artDetail .reprint-info{word-break:break-word}#artDetail .reprint:hover{box-shadow:0 0 10px 0 rgba(232,237,250,.6),0 4px 8px 0 rgba(232,237,250,.5)}#artDetail .reprint a{font-size:1.05rem;color:var(--post-link-color);font-weight:500}#articleContent p{margin:2px 2px 10px;font-size:1.05rem;line-height:1.85rem}#articleContent blockquote p{text-indent:.2rem}#articleContent a,#comments a{padding:0 2px;color:var(--post-link-color);font-weight:500;text-decoration:underline;word-wrap:break-word;cursor:pointer;transition:color .2s ease-in-out,background-color .2s ease-in-out}#articleContent a:hover,#comments a:hover{color:var(--link-hover-color);transition:color .2s ease-in-out,background-color .2s ease-in-out}#articleContent .img-item{text-align:center}#articleContent img{max-width:100%;height:auto;cursor:pointer}#articleContent video{display:block;margin:30px auto;box-shadow:0 5px 35px 0 rgba(0,0,0,.2),0 10px 35px -11px rgba(0,0,0,.6);cursor:pointer}#articleContent ol,#articleContent ul{display:block;padding-left:2em;word-spacing:.05rem}#articleContent ol li,#articleContent ul li{display:list-item;line-height:1.8rem;font-size:1rem}#articleContent ul li{list-style-type:disc}#articleContent ul ul li{list-style-type:circle}#articleContent table{width:100%;display:block;border-collapse:collapse;border-spacing:0;overflow:auto}table tr:nth-child(2n),thead{background-color:var(--table-tr-bg-color)}#articleContent table th{background-color:var(--table-th-bg-color);min-width:80px;border:1px solid var(--text-color);padding:6px 6px}#articleContent table td{min-width:80px;border:1px solid var(--text-color);padding:6px 6px}tbody tr:nth-child(even){background-color:var(--table-tr-bg-color)}td:nth-child(1){background-color:var(--table-td-bg-color)}#articleContent table th{background-color:var(--table-th-bg-color);border:1px solid var(--text-color);color:var(--text-color)}#articleContent [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible;opacity:1}.task-list label{color:var(--text-color);font-size:var(--text-font-size)}.task-list li::marker{content:""}@media only screen and (min-width:600px){#article-share .social-share a{margin-left:15px!important}}</style><link rel="stylesheet preload" as="style" href="https://cdn.jsdelivr.net/npm/tocbot@4.18.2/dist/tocbot.css"><link rel="stylesheet preload" as="style" href="/css/post.css"><link rel="stylesheet preload" as="style" href="https://cdn.jsdelivr.net/npm/tocbot@4.18.2/dist/tocbot.css"><link rel="stylesheet preload" as="style" href="/css/post.css"><link rel="stylesheet" type="text/css" href="/css/reward.css"><style>body.DarkMode .theme-btn{background:#222;border:2px solid #555;border-radius:2px;color:#ccc!important;display:inline-block;font-size:.875em;line-height:2;padding:0 5px!important;text-decoration:unset!important;transition:background-color .2s ease-in-out}body.DarkMode .theme-btn:hover{background:#666;border-color:#666;color:#ccc}.theme-btn{background:#fff;border:2px solid #222;border-radius:2px;color:#555!important;display:inline-block;font-size:.875em;line-height:2;padding:0 5px!important;text-decoration:unset!important;transition:background-color .2s ease-in-out}.theme-btn:hover{background:#222;border-color:#222;color:#fff!important}.theme-btn+.theme-btn{margin:0 0 8px 8px}.theme-btn .fa-fw{text-align:left;width:1.285714285714286em}</style><style>.post-container .note{border-radius:0;margin-bottom:20px;padding:1em;position:relative;border:1px solid #eee;border-left-width:5px}.post-container .note summary{cursor:pointer;outline:0}.post-container .note summary p{display:inline}.post-container .note h2,.post-container .note h3,.post-container .note h4,.post-container .note h5,.post-container .note h6{border-bottom:initial;margin:0;padding-top:0}.post-container .note blockquote:first-child,.post-container .note img:first-child,.post-container .note ol:first-child,.post-container .note p:first-child,.post-container .note pre:first-child,.post-container .note table:first-child,.post-container .note ul:first-child{margin-top:0}.post-container .note blockquote:last-child,.post-container .note img:last-child,.post-container .note ol:last-child,.post-container .note p:last-child,.post-container .note pre:last-child,.post-container .note table:last-child,.post-container .note ul:last-child{margin-bottom:0}.post-container .note:not(.no-icon){padding-left:2.5em}.post-container .note:not(.no-icon)::before{font-size:1.5em;left:.3em;position:absolute;top:calc(50% - 1em)}.post-container .note.default{border-left-color:#777}.post-container .note.default h2,.post-container .note.default h3,.post-container .note.default h4,.post-container .note.default h5,.post-container .note.default h6{color:#777}.post-container .note.default:not(.no-icon)::before{content:'\f0a9';font-family:'Font Awesome 5 Free';font-weight:900;color:#777}.post-container .note.primary{border-left-color:#6f42c1}.post-container .note.primary h2,.post-container .note.primary h3,.post-container .note.primary h4,.post-container .note.primary h5,.post-container .note.primary h6{color:#6f42c1}.post-container .note.primary:not(.no-icon)::before{content:'\f055';font-family:'Font Awesome 5 Free';font-weight:900;color:#6f42c1}.post-container .note.info{border-left-color:#428bca}.post-container .note.info h2,.post-container .note.info h3,.post-container .note.info h4,.post-container .note.info h5,.post-container .note.info h6{color:#428bca}.post-container .note.info:not(.no-icon)::before{content:'\f05a';font-family:'Font Awesome 5 Free';font-weight:900;color:#428bca}.post-container .note.success{border-left-color:#5cb85c}.post-container .note.success h2,.post-container .note.success h3,.post-container .note.success h4,.post-container .note.success h5,.post-container .note.success h6{color:#5cb85c}.post-container .note.success:not(.no-icon)::before{content:'\f058';font-family:'Font Awesome 5 Free';font-weight:900;color:#5cb85c}.post-container .note.warning{border-left-color:#f0ad4e}.post-container .note.warning h2,.post-container .note.warning h3,.post-container .note.warning h4,.post-container .note.warning h5,.post-container .note.warning h6{color:#f0ad4e}.post-container .note.warning:not(.no-icon)::before{content:'\f06a';font-family:'Font Awesome 5 Free';font-weight:900;color:#f0ad4e}.post-container .note.danger{border-left-color:#d9534f}.post-container .note.danger h2,.post-container .note.danger h3,.post-container .note.danger h4,.post-container .note.danger h5,.post-container .note.danger h6{color:#d9534f}.post-container .note.danger:not(.no-icon)::before{content:'\f056';font-family:'Font Awesome 5 Free';font-weight:900;color:#d9534f}</style><style>.post-container .tabs{margin-bottom:20px;height:auto}.post-container .tabs,.tabs-comment{padding-top:10px}.post-container .tabs ul.nav-tabs,.tabs-comment ul.nav-tabs{background:var(--card-bg-color);display:flex!important;flex-wrap:wrap;justify-content:center;margin:0;padding:0!important;position:-webkit-sticky;position:sticky;top:0}@media (max-width:413px){.post-container .tabs ul.nav-tabs,.tabs-comment ul.nav-tabs{display:block;margin-bottom:5px}}.post-container .tabs ul.nav-tabs li.tab,.tabs-comment ul.nav-tabs li.tab{border-bottom:1px solid var(--text-color);border-left:1px solid transparent;border-right:1px solid transparent;border-radius:0;border-top:3px solid transparent;flex-grow:1;list-style-type:none!important;transition:all .2s ease-out}@media (max-width:413px){.post-container .tabs ul.nav-tabs li.tab,.tabs-comment ul.nav-tabs li.tab{border-bottom:1px solid transparent;border-left:3px solid transparent;border-right:1px solid transparent;border-top:1px solid transparent}}@media (max-width:413px){.post-container .tabs ul.nav-tabs li.tab,.tabs-comment ul.nav-tabs li.tab{border-radius:0}}.post-container .tabs ul.nav-tabs li.tab a,.tabs-comment ul.nav-tabs li.tab a{border-bottom:initial;display:block;line-height:1.8;padding:.25em .75em;text-align:center;text-decoration:unset!important;transition:all .2s ease-out}.post-container .tabs{background-color:var(--card-bg-color)}.post-container .tabs ul.nav-tabs li.tab a i,.tabs-comment ul.nav-tabs li.tab a i{width:1.285714285714286em}.post-container .tabs ul.nav-tabs li.tab.active,.tabs-comment ul.nav-tabs li.tab.active{border-bottom-color:transparent;border-left-color:var(--text-color);border-right-color:var(--text-color);border-top-color:var(--tab-border-top-color)}@media (max-width:413px){.post-container .tabs ul.nav-tabs li.tab.active,.tabs-comment ul.nav-tabs li.tab.active{border-bottom-color:var(--text-color);border-left-color:var(--tab-border-top-color);border-right-color:var(--text-color);border-top-color:var(--text-color)}}.post-container .tabs ul.nav-tabs li.tab.active a,.tabs-comment ul.nav-tabs li.tab.active a{cursor:default;text-decoration:unset}.post-container .tabs .tab-content,.tabs-comment .tab-content{border:1px solid var(--text-color);border-radius:0;border-top-color:transparent;white-space:break-spaces}@media (max-width:413px){.post-container .tabs .tab-content,.tabs-comment .tab-content{border-radius:0;border-top-color:var(--text-color)}}.post-container .tabs .tab-content .tab-pane,.tabs-comment .tab-content .tab-pane{padding:20px 20px 0}.post-container .tabs .tab-content .tab-pane:not(.active),.tabs-comment .tab-content .tab-pane:not(.active){display:none}.tabs-comment{margin-top:4em;padding-top:0}.tabs-comment .comments{margin-top:0;padding-top:0}</style><style>.label{display:inline;border-radius:3px;font-size:85%;margin:0;padding:.2em .4em;color:var(--text-color);transition:color .2s ease-in-out}.label-default{background:rgba(187,187,187,.25)}.label-primary{background:rgba(183,160,224,.25)}.label-info{background:rgba(160,197,228,.25)}.label-success{background:rgba(174,220,174,.25)}.label-warning{background:rgba(248,214,166,.25)}.label-danger{background:rgba(236,169,167,.25)}</style><style>.group-image-container{margin:1.5rem auto}.group-image-container img{margin:0 auto;border-radius:3px;background-color:transparent;box-shadow:0 3px 9px 0 rgba(0,0,0,.15),0 3px 9px 0 rgba(0,0,0,.15)}.group-image-row{margin-bottom:.5rem;display:flex;justify-content:center}.group-image-wrap{flex:1;display:flex;justify-content:center}.group-image-wrap:not(:last-child){margin-right:.25rem}</style><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@waline/client@v2/dist/waline.min.css" media="none" onload='"all"!=media&&(media="all")'><link rel="stylesheet" type="text/css" href="/css/waline.css" media="none" onload='"all"!=media&&(media="all")'><style>.admonition,.admonition.attention,.admonition.error,.admonition.info,.admonition.note{margin:1.5625em 0;padding:.6rem!important;overflow:hidden;font-size:.64rem;page-break-inside:avoid;border-left:.3rem solid #42b983;border-radius:.3rem;box-shadow:0 .1rem .4rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1);background-color:var(--toc-activ-bg-color)}p.admonition-title{position:relative;margin:-.6rem -.6rem .8em -.6rem!important;padding:.4rem .6rem .4rem 2.5rem;font-weight:700;background-color:rgba(66,185,131,.1)}.admonition-title::before{position:absolute;top:.9rem;left:1rem;width:12px;height:12px;background-color:#42b983;border-radius:50%;content:' '}.info>.admonition-title,.todo>.admonition-title{background-color:rgba(0,184,212,.1)}.attention>.admonition-title,.caution>.admonition-title,.warning>.admonition-title{background-color:rgba(255,145,0,.1)}.error>.admonition-title,.fail>.admonition-title,.failure>.admonition-title,.missing>.admonition-title{background-color:rgba(255,82,82,.1)}.admonition.info,.admonition.todo{border-color:#00b8d4}.admonition.attention,.admonition.caution,.admonition.warning{border-color:#ff9100}.admonition.error,.admonition.fail,.admonition.failure,.admonition.missing{border-color:#ff5252}.info>.admonition-title::before,.todo>.admonition-title::before{background-color:#00b8d4;border-radius:50%}.attention>.admonition-title::before,.caution>.admonition-title::before,.warning>.admonition-title::before{background-color:#ff9100;border-radius:50%}.error>.admonition-title::before,.fail>.admonition-title::before,.failure>.admonition-title::before,.missing>.admonition-title::before{background-color:#ff5252;border-radius:50%}.admonition>:last-child{margin-bottom:0!important}.admonition code[class*=language-],.admonition pre[class*=language-]{background:var(--toc-activ-bg-color)!important}</style><style>.bvideo a:link{text-decoration:none!important}.bvideo-box{width:80%;height:96px;margin:0 auto;font-weight:400;box-sizing:border-box;background:#f4f4f5;border:.0625rem solid #d1d1d1;border-radius:6px;background-color:#fcfcfc;display:flex;user-select:none;cursor:pointer;overflow:hidden}.bvideo-cover{display:inline-block;width:150px;height:94px;min-width:150px;min-height:94px;border-bottom-left-radius:6px;border-top-left-radius:6px;overflow:hidden;position:relative}.bvideo-cover .video-cover-img{height:100%;width:100%;top:0;left:0;position:absolute;display:inline-block;background-size:cover;background-position:50%}.bvideo-cover .duration{position:absolute;right:3px;bottom:0;padding:0;color:#fff;font-size:12px;border-radius:2px}.bvideo-cover .bvideo-cover-layer{position:absolute;left:0;top:0;width:100%;height:100%;background-position:50%;background-size:cover;background-repeat:no-repeat}.bvideo-info{margin-left:1rem;padding-top:10px;min-height:84px;position:relative;text-align:left}.bvideo-info .title{max-height:40px;min-height:19px;color:#222;line-height:1.4;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:25rem;margin:0}.bvideo-info .up-name{height:19px;margin-top:1px;margin-left:2px;display:inline-block;vertical-align:middle;font-size:12px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;max-width:150px}.bvideo-info .card-status{line-height:13px;font-size:12px;color:#999;margin:0;bottom:30px}.bvideo-info .play-num{margin-right:13px}.bvideo-info .partition{font-size:12px;line-height:13px;color:#999;position:absolute;bottom:-1px;padding-left:35px;top:78px}.icon-video{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA2CAMAAACsuQomAAAAclBMVEX///8AAAD///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+As+VLAAAAJnRSTlOzAK8+F4OppBAmnTKsllOOb2dhOS0JBJqAWk0aB19FHgJ8dUAgC8ZU4VsAAAGPSURBVEjHpdbrcqowGIXhtbIxnEGOCmKt2n3/t1hSO6Y2qYwf779M5plkCJkJ+Fih85i+4lwX/NUvHAHQLd3SDED0HHcagGoc2ygA4eRidwV15WNvytmRDzPWmBv5sxFzYcxFzI8QcwVtw5c9kcuYhwRz9X1cYS4J+Cfu4+bfvUJhbvs9umBOFXY6PT3gqNJ4pWSY7rhx6DL/+MZXhdfTRoOnDJJ2ncEbyBpIxBCmJ+IIaSlRivGRCOGpbMdkEV8IBU8t2R3VAt4T3gLOBefnePMMk2m+ArMvtByT0VaAbXEpwLa3cAXm/0rJMXnaCLCtSVZgRvkKzOOalXcCbM9LiuMSEGLzjwqxuR1SnO4AIT7sASHuagUpNscjw+7xuDiDp9Q9HrczkcBTfq01ltoSe0gbiVGMD0SUCe2GBGshbg2ecpGtaDCDncBe+htmdH6VquHdPuLabZ4pdZ/yZSfDcgjc52MDk36nrz6DKeVXLu6S25fwV90eUA62l1eFdU9/Ux2q/YEOtjlbfjoLrugTV6YSSQ5kbxYAAAAASUVORK5CYII=);position:absolute;background-size:100% 100%;display:inline-block;top:50%;left:50%;margin-left:-15px;margin-top:-13px;height:26px}.card-label{display:inline-block;font-weight:550;width:25px;height:13px;border:1.5px solid #ffc3d4;color:#ffc3d4;background-size:100% 100%;position:absolute;top:-1px;left:0;padding-left:1px}.bvideo-cover .cover-default{position:absolute;left:0;top:0;width:100%;height:100%;background-size:44px;background-color:#f0f1f4;background-position:50%;background-repeat:no-repeat}@media (max-width:768px){.bvideo-cover{display:none}.partition{display:none}.bvideo-info .title{max-height:40px;min-height:19px;color:#222;line-height:1.4;font-size:14px;text-overflow:clip;overflow:hidden;white-space:normal;margin:0}}</style><style>.douban-card-block{display:flex;justify-content:center;align-items:center;width:100%;max-height:400px}.douban-card{display:flex;margin:30px 10px;padding:15px;border-radius:15px;position:relative;justify-content:center;align-items:center;overflow:hidden;color:#faebd7;text-decoration:none}.douban-card:hover{text-decoration:none}.douban-card-bgimg{position:absolute;width:115%;height:115%;filter:blur(15px) brightness(.6);background-size:100%;background-position:center;background-repeat:no-repeat}.douban-card-img{position:relative;height:130px;width:80px;background-size:100%;background-position:center;background-repeat:no-repeat}.douban-card-left:hover .douban-card-img{filter:blur(5px) brightness(.6);transform:perspective(800px) rotateX(180deg)}.douban-card-left .douban-card-img{transition:all .5s ease}.douban-card-left{position:relative;display:flex;flex-direction:column;align-items:center}.douban-card-left .douban-card-status{height:130px;width:80px;text-align:center;font-weight:700;position:absolute;left:0;top:30%;transform:rotateX(180deg);backface-visibility:hidden;transition:all .5s ease}.douban-card-left:hover .douban-card-status{transform:perspective(800px) rotateX(0)}.douban-card-right{position:relative;display:flex;flex-direction:column;margin-left:12px;font-size:16px;font-family:"Courier New",Courier,monospace;line-height:1.3;color:#faebd7}.douban-card-item{margin-top:4px}</style><style>.github-emoji{height:2em;width:2em;display:inline-block!important;position:relative;margin:0 3px!important;padding:0}.github-emoji:hover{animation:emoji-face 5s infinite ease-in-out}@keyframes emoji-face{2%{transform:translate(0,1.5px) rotate(1.5deg)}4%{transform:translate(0,-1.5px) rotate(-.5deg)}6%{transform:translate(0,1.5px) rotate(-1.5deg)}8%{transform:translate(0,-1.5px) rotate(-1.5deg)}10%{transform:translate(0,2.5px) rotate(1.5deg)}12%{transform:translate(0,-.5px) rotate(1.5deg)}14%{transform:translate(0,-1.5px) rotate(1.5deg)}16%{transform:translate(0,-.5px) rotate(-1.5deg)}18%{transform:translate(0,.5px) rotate(-1.5deg)}20%{transform:translate(0,-1.5px) rotate(2.5deg)}22%{transform:translate(0,.5px) rotate(-1.5deg)}24%{transform:translate(0,1.5px) rotate(1.5deg)}26%{transform:translate(0,.5px) rotate(.5deg)}28%{transform:translate(0,.5px) rotate(1.5deg)}}</style><style>.vkr-url-wrapper{padding:10px;border-radius:5px;border:1px solid;border-color:var(--text-color) var(--text-color) var(--text-color);box-shadow:rgba(0,0,0,.14) 0 1px 3px;margin-bottom:10px;display:flex}.vkr-url-wrapper .desc-wrapper>hr{margin:10px 0;height:1px}.vkr-url-wrapper .avatar{width:150px!important;height:150px!important;border:solid 1px var(--text-color);box-shadow:none!important;margin:0;margin-right:10px}.vkr-url-wrapper h2{border:none;margin:0;padding:0}.vkr-url-wrapper .desc-wrapper{flex:1}.vkr-url-wrapper .desc-wrapper a{font-size:22px;font-weight:700}</style><style>.typed-cursor.typed-cursor--blink{-webkit-animation:1s van-cursor-flicker infinite;animation:1s van-cursor-flicker infinite}#articles .article .card-image i,#next-cover i,#prev-cover i,#recommend-sections .post-card .post-body i,.index-cover .container .cover-btns i,.paging i{-webkit-animation:1.5s breathe-flicker infinite;animation:1.5s breathe-flicker infinite}@keyframes van-cursor-flicker{from{opacity:0}50%{opacity:1}100%{opacity:0}}@keyframes breathe-flicker{from{opacity:.3}50%{opacity:1}100%{opacity:.3}}@media only screen and (max-width:1024px){.typed-cursor.typed-cursor--blink{-webkit-animation:none;animation:none}#articles .article .card-image i,#next-cover i,#prev-cover i,#recommend-sections .post-card .post-body i,.index-cover .container .cover-btns i,.paging i{-webkit-animation:none;animation:none}}</style><style>::-webkit-scrollbar-thumb{background-color:var(--scrollbar-color);background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,.4) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.4) 50%,rgba(255,255,255,.4) 75%,transparent 75%,transparent);border-radius:6px}::-webkit-scrollbar-corner,::-webkit-scrollbar-track{background-color:var(--card-bg-color);border-radius:3em}::-webkit-scrollbar-thumb:hover{background-color:var(--scrollbar-hover-color)}::-webkit-scrollbar{width:8px;height:8px}</style><link rel="stylesheet preload" as="style" type="text/css" href="/libs/live2d/waifu.css"><link rel="preload" href="/libs/materialize/materialize.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.min.js" as="script"><link rel="preload" href="/js/matery.js" as="script"><link rel="preload" href="/js/events.js" as="script"><link rel="preload" href="/js/plugins.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery-all.min.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery-ui@1.13.2/dist/jquery-ui.min.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/npm/scrollprogress@3.0.2/dist/scrollProgress.min.js" as="script"><link rel="preload" href="/js/img-lazyload.js" as="script" importance="low"><link rel="preload" href="/js/boot.js" as="script" importance="low"><link rel="preload" href="https://cdn.jsdelivr.net/npm/tocbot@4.18.2/dist/tocbot.min.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/npm/hexo-tag-common-new@latest/js/index.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@waline/client@v2/dist/pageview.min.mjs" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@waline/client@v2/dist/comment.min.mjs" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.min.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js" as="script"><link rel="stylesheet preload" as="style" type="text/css" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js" as="script"><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script><script id="matery-configs">var Matery=window.Matery||{};Matery.ctx=Object.assign({},Matery.ctx);var CONFIG={hostname:"blog.17lai.site",root:"/",version:"2.0.0",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!1,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,show_full:!0,show_expand:!0,shrink:!0,break:!1,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/medias_webp/loading2.svg",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!1,baidu:{enable:!0,id:"22cc5bdea6e529c1349d44b7306b3b8c"},google:{enable:!1,id:"G-JNYZP4ZLDJ"},gtag:{enable:!0,id:"G-JNYZP4ZLDJ"},tencent:{enable:!1,sid:null,cid:null},woyaola:{enable:!1,id:null},cnzz:{enable:!1,id:null},leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Matery.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>if(!Matery.ctx.dnt){var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?22cc5bdea6e529c1349d44b7306b3b8c";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()}</script><script async>Matery.ctx.dnt||Matery.utils.createScript("/js/gt.min.js?id=G-JNYZP4ZLDJ",(function(){function t(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],t("js",new Date),t("config","G-JNYZP4ZLDJ")}))</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css"><script async>var supportsPassive=!1;try{var opts=Object.defineProperty({},"passive",{get:function(){supportsPassive=!0}});window.addEventListener("testpassive",null,opts),window.removeEventListener("testpassive",null,opts)}catch(s){}</script><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body class="lazy-background" bg-lazy><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img no-lazy src="/favicon.webp" style="width:40px;height:45px" class="logo-img" alt="LOGO"> <span class="logo-span">夜法之书</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse" aria-label="侧边菜单"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item menu-2d-home"><a href="/" class="nav-link"><i class="fas fa-home" style="zoom:.6"></i> 首页</a></li><li class="hide-on-med-and-down nav-item menu-2d-nav"><a target="_blank" rel="noopener" href="https://nav.17lai.site/" class="nav-link"><i class="fas fa-suitcase" style="zoom:.6"></i> 导航</a></li><li class="hide-on-med-and-down nav-item menu-2d-sosuo"><a target="_blank" rel="noopener" href="https://so.17lai.site/" class="nav-link"><i class="fas fa-mask" style="zoom:.6"></i> SO</a></li><li class="hide-on-med-and-down nav-item menu-2d-media"><a href="#" class="nav-link"><i class="fas fa-music" style="zoom:.6"></i> 多媒体 <i class="fas fa-chevron-down" aria-hidden="true" style="zoom:.6"></i></a><ul class="sub-nav menus_item_child"><li class="menu-2d-musics"><a class="nav-link" href="/musics/"><i class="fas fa-music" style="margin-top:-20px;zoom:.6"></i> 音乐</a></li><li class="menu-2d-galleries"><a class="nav-link" href="/galleries/"><i class="fas fa-image" style="margin-top:-20px;zoom:.6"></i> 相册</a></li><li class="menu-2d-movies"><a class="nav-link" href="/movies/"><i class="fas fa-film" style="margin-top:-20px;zoom:.6"></i> 视频</a></li><li class="menu-2d-musicplayer"><a class="nav-link" target="_blank" rel="noopener" href="https://musicplayer.17lai.site/"><i class="fas fa-music" style="margin-top:-20px;zoom:.6"></i> 在线云音乐</a></li><li class="menu-2d-music"><a class="nav-link" target="_blank" rel="noopener" href="https://music.17lai.site/"><i class="fas fa-music" style="margin-top:-20px;zoom:.6"></i> 音乐播放器</a></li></ul></li><li class="hide-on-med-and-down nav-item menu-2d-posts"><a href="#" class="nav-link"><i class="fas fa-folder-plus" style="zoom:.6"></i> 文章 <i class="fas fa-chevron-down" aria-hidden="true" style="zoom:.6"></i></a><ul class="sub-nav menus_item_child"><li class="menu-2d-tags"><a class="nav-link" href="/tags/"><i class="fas fa-tags" style="margin-top:-20px;zoom:.6"></i> 标签</a></li><li class="menu-2d-categories"><a class="nav-link" href="/categories/"><i class="fas fa-bookmark" style="margin-top:-20px;zoom:.6"></i> 分类</a></li><li class="menu-2d-archives"><a class="nav-link" href="/archives/"><i class="fas fa-archive" style="margin-top:-20px;zoom:.6"></i> 归档</a></li></ul></li><li class="hide-on-med-and-down nav-item menu-2d-friends"><a href="/friends/" class="nav-link"><i class="fas fa-link" style="zoom:.6"></i> 友链</a></li><li class="hide-on-med-and-down nav-item menu-2d-cheatsheets"><a href="#" class="nav-link"><i class="fas fa-code" style="zoom:.6"></i> 快查 <i class="fas fa-chevron-down" aria-hidden="true" style="zoom:.6"></i></a><ul class="sub-nav menus_item_child"><li class="menu-2d-cheatsheets"><a class="nav-link" href="/cheatsheets/Vim_CN.docset/Contents/Resources/Documents/"><i class="fab fa-vimeo-v" style="margin-top:-20px;zoom:.6"></i> Vim快查表</a></li><li class="menu-2d-cheatsheets"><a class="nav-link" href="/cheatsheets/Visual_Studio_Code.docset/Contents/Resources/Documents/"><i class="fas fa-code" style="margin-top:-20px;zoom:.6"></i> VSCode快查表</a></li><li class="menu-2d-cheatsheets"><a class="nav-link" href="/cheatsheets/Git.docset/Contents/Resources/Documents/"><i class="fab fa-git-square" style="margin-top:-20px;zoom:.6"></i> Git快查表</a></li><li class="menu-2d-cheatsheets"><a class="nav-link" href="/cheatsheets/SQLite.docset/Contents/Resources/Documents/"><i class="fas fa-database" style="margin-top:-20px;zoom:.6"></i> SQLite快查表</a></li><li class="menu-2d-cheatsheets"><a class="nav-link" href="/cheatsheets/tmux.docset/Contents/Resources/Documents/"><i class="fas fa-terminal" style="margin-top:-20px;zoom:.6"></i> Tmux快查表</a></li><li class="menu-2d-cheatsheets"><a class="nav-link" href="/cheatsheets/Bash_Shortcuts.docset/Contents/Resources/Documents/"><i class="fas fa-terminal" style="margin-top:-20px;zoom:.6"></i> Bash快查表</a></li><li class="menu-2d-cheatsheets"><a class="nav-link" href="/dash/"><i class="fas fa-laptop-code" style="margin-top:-20px;zoom:.6"></i> 更多快查表</a></li></ul></li><li class="hide-on-med-and-down nav-item menu-2d-toolbox"><a href="#" class="nav-link"><i class="fas fa-toolbox" style="zoom:.6"></i> 工具 <i class="fas fa-chevron-down" aria-hidden="true" style="zoom:.6"></i></a><ul class="sub-nav menus_item_child"><li class="menu-2d-tg"><a class="nav-link" target="_blank" rel="noopener" href="https://t.me/chat_17laisite"><i class="fab fa-telegram-plane" style="margin-top:-20px;zoom:.6"></i> TG交流群</a></li><li class="menu-2d-tg-sub"><a class="nav-link" target="_blank" rel="noopener" href="https://t.me/sub_17laisite"><i class="fab fa-telegram-plane" style="margin-top:-20px;zoom:.6"></i> TG订阅群</a></li><li class="menu-2d-linuxtool"><a class="nav-link" target="_blank" rel="noopener" href="https://linux-command.17lai.site/"><i class="fas fa-terminal" style="margin-top:-20px;zoom:.6"></i> Linux命令</a></li><li class="menu-2d-onebox"><a class="nav-link" target="_blank" rel="noopener" href="https://onebox.17lai.site/"><i class="fas fa-cloud" style="margin-top:-20px;zoom:.6"></i> 私人网盘</a></li><li class="menu-2d-encdec"><a class="nav-link" target="_blank" rel="noopener" href="http://encode.chahuo.com/"><i class="fas fa-tools" style="margin-top:-20px;zoom:.6"></i> 加密解密</a></li><li class="menu-2d-markmap"><a class="nav-link" target="_blank" rel="noopener" href="https://markmap.js.org/repl"><i class="fas fa-brain" style="margin-top:-20px;zoom:.6"></i> 思维导图</a></li><li class="menu-2d-aIcon"><a class="nav-link" target="_blank" rel="noopener" href="https://fontawesome.com/v6/search"><i class="fab fa-font-awesome" style="margin-top:-20px;zoom:.6"></i> Awesome</a></li><li class="menu-2d-zhanzhang"><a class="nav-link" target="_blank" rel="noopener" href="http://ping.chinaz.com/"><i class="fas fa-tools" style="margin-top:-20px;zoom:.6"></i> 站长工具</a></li><li class="menu-2d-toolport"><a class="nav-link" target="_blank" rel="noopener" href="http://tool.chinaz.com/port/"><i class="fas fa-tools" style="margin-top:-20px;zoom:.6"></i> 端口扫描</a></li><li class="menu-2d-staticnav"><a class="nav-link" href="/nav/"><i class="fas fa-tools" style="margin-top:-20px;zoom:.6"></i> 网址导航</a></li><li class="menu-2d-devbox"><a class="nav-link" target="_blank" rel="noopener" href="https://devtool.tech/"><i class="fas fa-tools" style="margin-top:-20px;zoom:.6"></i> Devtools</a></li></ul></li><li class="hide-on-med-and-down nav-item menu-2d-about"><a href="#" class="nav-link"><i class="fas fa-id-badge" style="zoom:.6"></i> 关于 <i class="fas fa-chevron-down" aria-hidden="true" style="zoom:.6"></i></a><ul class="sub-nav menus_item_child"><li class="site-author menu-2d-aboutme"><a class="nav-link" href="/about/"><i class="fas fa-user-circle" style="margin-top:-20px;zoom:.6"></i> 关于我</a></li><li class="menu-2d-abouttech"><a class="nav-link" href="/myTeck/"><i class="fas fa-address-card" style="margin-top:-20px;zoom:.6"></i> 我的技术</a></li><li class="menu-2d-aboutporj"><a class="nav-link" href="/myProject/"><i class="fas fa-laptop-code" style="margin-top:-20px;zoom:.6"></i> 我的项目</a></li><li class="menu-2d-aboutpost"><a class="nav-link" href="/myPost/"><i class="fas fa-pen-nib" style="margin-top:-20px;zoom:.6"></i> 我的文章</a></li><li class="menu-2d-aboutneed"><a class="nav-link" href="/needtoread/"><i class="fas fa-exclamation-circle" style="margin-top:-20px;zoom:.6"></i> 博客须知</a></li></ul></li><li class="nav-item menu-2d-search"><a href="#searchModal" class="nav-link modal-trigger" onclick="startXMLSearch()"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li><li class="nav-item menu-2d-dark" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp; <i class="fas fa-sun" id="color-toggle-icon" style="zoom:.85"></i>&nbsp;</a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><div><img src="/favicon.webp" srcset="/medias_webp/loading2.svg" loading="lazy" lazyload style="width:45px;height:45px" class="logo-img circle responsive-img" alt="LOGO"><div class="logo-name">夜法之书</div><div class="logo-desc">~软件驱动世界~个人独立技术博客，关于Linux,开源，Nas，Docker，嵌入式，理财，健身等主题！</div></div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a target="_blank" rel="noopener" href="https://nav.17lai.site/" class="waves-effect waves-light"><i class="fa-fw fas fa-suitcase"></i> 导航</a></li><li class="m-nav-item"><a target="_blank" rel="noopener" href="https://so.17lai.site/" class="waves-effect waves-light"><i class="fa-fw fas fa-mask"></i> SO</a></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fas fa-music"></i> 多媒体 <span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/musics/" style="margin-left:75px"><i class="fa fas fa-music" style="position:absolute;left:50px"></i> <span>音乐</span></a></li><li><a href="/galleries/" style="margin-left:75px"><i class="fa fas fa-image" style="position:absolute;left:50px"></i> <span>相册</span></a></li><li><a href="/movies/" style="margin-left:75px"><i class="fa fas fa-film" style="position:absolute;left:50px"></i> <span>视频</span></a></li><li><a target="_blank" rel="noopener" href="https://musicplayer.17lai.site/" style="margin-left:75px"><i class="fa fas fa-music" style="position:absolute;left:50px"></i> <span>在线云音乐</span></a></li><li><a target="_blank" rel="noopener" href="https://music.17lai.site/" style="margin-left:75px"><i class="fa fas fa-music" style="position:absolute;left:50px"></i> <span>音乐播放器</span></a></li></ul></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fas fa-folder-plus"></i> 文章 <span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/tags/" style="margin-left:75px"><i class="fa fas fa-tags" style="position:absolute;left:50px"></i> <span>标签</span></a></li><li><a href="/categories/" style="margin-left:75px"><i class="fa fas fa-bookmark" style="position:absolute;left:50px"></i> <span>分类</span></a></li><li><a href="/archives/" style="margin-left:75px"><i class="fa fas fa-archive" style="position:absolute;left:50px"></i> <span>归档</span></a></li></ul></li><li class="m-nav-item"><a href="/friends/" class="waves-effect waves-light"><i class="fa-fw fas fa-link"></i> 友链</a></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fas fa-code"></i> 快查 <span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/cheatsheets/Vim_CN.docset/Contents/Resources/Documents/" style="margin-left:75px"><i class="fa fab fa-vimeo-v" style="position:absolute;left:50px"></i> <span>Vim快查表</span></a></li><li><a href="/cheatsheets/Visual_Studio_Code.docset/Contents/Resources/Documents/" style="margin-left:75px"><i class="fa fas fa-code" style="position:absolute;left:50px"></i> <span>VSCode快查表</span></a></li><li><a href="/cheatsheets/Git.docset/Contents/Resources/Documents/" style="margin-left:75px"><i class="fa fab fa-git-square" style="position:absolute;left:50px"></i> <span>Git快查表</span></a></li><li><a href="/cheatsheets/SQLite.docset/Contents/Resources/Documents/" style="margin-left:75px"><i class="fa fas fa-database" style="position:absolute;left:50px"></i> <span>SQLite快查表</span></a></li><li><a href="/cheatsheets/tmux.docset/Contents/Resources/Documents/" style="margin-left:75px"><i class="fa fas fa-terminal" style="position:absolute;left:50px"></i> <span>Tmux快查表</span></a></li><li><a href="/cheatsheets/Bash_Shortcuts.docset/Contents/Resources/Documents/" style="margin-left:75px"><i class="fa fas fa-terminal" style="position:absolute;left:50px"></i> <span>Bash快查表</span></a></li><li><a href="/dash/" style="margin-left:75px"><i class="fa fas fa-laptop-code" style="position:absolute;left:50px"></i> <span>更多快查表</span></a></li></ul></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fas fa-toolbox"></i> 工具 <span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a target="_blank" rel="noopener" href="https://t.me/chat_17laisite" style="margin-left:75px"><i class="fa fab fa-telegram-plane" style="position:absolute;left:50px"></i> <span>TG交流群</span></a></li><li><a target="_blank" rel="noopener" href="https://t.me/sub_17laisite" style="margin-left:75px"><i class="fa fab fa-telegram-plane" style="position:absolute;left:50px"></i> <span>TG订阅群</span></a></li><li><a target="_blank" rel="noopener" href="https://linux-command.17lai.site/" style="margin-left:75px"><i class="fa fas fa-terminal" style="position:absolute;left:50px"></i> <span>Linux命令</span></a></li><li><a target="_blank" rel="noopener" href="https://onebox.17lai.site/" style="margin-left:75px"><i class="fa fas fa-cloud" style="position:absolute;left:50px"></i> <span>私人网盘</span></a></li><li><a target="_blank" rel="noopener" href="http://encode.chahuo.com/" style="margin-left:75px"><i class="fa fas fa-tools" style="position:absolute;left:50px"></i> <span>加密解密</span></a></li><li><a target="_blank" rel="noopener" href="https://markmap.js.org/repl" style="margin-left:75px"><i class="fa fas fa-brain" style="position:absolute;left:50px"></i> <span>思维导图</span></a></li><li><a target="_blank" rel="noopener" href="https://fontawesome.com/v6/search" style="margin-left:75px"><i class="fa fab fa-font-awesome" style="position:absolute;left:50px"></i> <span>Awesome</span></a></li><li><a target="_blank" rel="noopener" href="http://ping.chinaz.com/" style="margin-left:75px"><i class="fa fas fa-tools" style="position:absolute;left:50px"></i> <span>站长工具</span></a></li><li><a target="_blank" rel="noopener" href="http://tool.chinaz.com/port/" style="margin-left:75px"><i class="fa fas fa-tools" style="position:absolute;left:50px"></i> <span>端口扫描</span></a></li><li><a href="/nav/" style="margin-left:75px"><i class="fa fas fa-tools" style="position:absolute;left:50px"></i> <span>网址导航</span></a></li><li><a target="_blank" rel="noopener" href="https://devtool.tech/" style="margin-left:75px"><i class="fa fas fa-tools" style="position:absolute;left:50px"></i> <span>Devtools</span></a></li></ul></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fas fa-id-badge"></i> 关于 <span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/about/" style="margin-left:75px"><i class="fa fas fa-user-circle" style="position:absolute;left:50px"></i> <span>关于我</span></a></li><li><a href="/myTeck/" style="margin-left:75px"><i class="fa fas fa-address-card" style="position:absolute;left:50px"></i> <span>我的技术</span></a></li><li><a href="/myProject/" style="margin-left:75px"><i class="fa fas fa-laptop-code" style="position:absolute;left:50px"></i> <span>我的项目</span></a></li><li><a href="/myPost/" style="margin-left:75px"><i class="fa fas fa-pen-nib" style="position:absolute;left:50px"></i> <span>我的文章</span></a></li><li><a href="/needtoread/" style="margin-left:75px"><i class="fa fas fa-exclamation-circle" style="position:absolute;left:50px"></i> <span>博客须知</span></a></li></ul></li></ul></div></div></nav></header><script>pagePath=window.location.pathname</script><div id="banner" class="bg-cover pd-header post-cover" style="background-image:url(/medias_webp/cover/docker.webp)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand center"><h1 class="description center-align post-title">使用 Shell 脚本实现一个简单 Docker <span class="typed-cursor h2 typed-cursor--blink" aria-hidden="true">_</span></h1><div class="center-align"><div id="waline_container_page_pv" style="display:inline"><i class="far fa-eye fa-fw"></i>查阅:&nbsp;&nbsp; <span class="waline-pageview-count" data-path=""></span>&nbsp;&nbsp;</div><div id="waline_container_comment_count" style="display:inline"><i class="far fa-comment fa-fw"></i>评论:&nbsp;&nbsp; <span class="waline-comment-count" data-path=""></span>条</div></div></div></div></div></div></div><main class="post-container content"><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/linux/"><span class="chip bg-color">linux</span> </a><a href="/tags/docker/"><span class="chip bg-color">docker</span> </a><a href="/tags/shell/"><span class="chip bg-color">shell</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/docker/" class="post-category">docker</a><link rel="alternate dns-prefetch" type="application/atom+xml" title="分类订阅--docker" href="https://blog.17lai.site/categories/docker/atom.xml"></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i> <span>发布:&nbsp;&nbsp;</span><time datetime="2022-03-18 14:33" pubdate> 2022年3月18日 下午</time></div><div class="post-date info-break-policy"><i class="far fa-calendar-check fa-fw"></i> <span>更新:&nbsp;&nbsp;</span><time datetime="2022-05-18 00:19" update> 2022年5月18日 凌晨</time></div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i>字数:&nbsp;&nbsp; 14.4k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i>阅时:&nbsp;&nbsp; 60 分</div><div id="read_mode" class="info-break-policy" style="display:inline"><i class="fas fa-expand" title="【进入/离开】阅读模式" aria-hidden="true"></i>&nbsp;&nbsp;<span title="【进入/离开】阅读模式" aria-hidden="true">阅读模式</span></div></div></div><hr class="clearfix"><div class="card-content article-card-content markdown-body"><div id="articleContent"><blockquote><p>《使用 Shell 脚本实现 Docker》旨在通过一系列的实验使用户对docker的底层技术，如Namespace、CGroups、rootfs、联合加载等有一个感性的认识。在此过程中，我们还将通过Shell脚本一步一步地实现一个简易的docker，以期使读者在使用docker的过程中知其然知其所以然。</p></blockquote><p>我们的实验环境为Ubuntu 18.04 64bit，<a target="_blank" rel="noopener" href="http://xn--dockerdocker-4f5sj66dz5y68i548a335dg9n50g.sh">简易docker工程的名字为docker.sh</a>，该工程仓库地址如下：</p><figure><div class="code-area"><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">https://github.com/pandengyang/docker.sh.git
https://github.com/appotry/docker.sh</code></pre></div></figure><p>《使用 Shell 脚本实现 Docker》目录如下：</p><figure><div class="code-area"><pre class="line-numbers language-none"><code class="language-none">1. Namespace
1.1. Namespace简介
1.2. uts namespace
1.2.1. uts namespace简介
1.2.2. docker.sh
1.3. mount namespace
1.3.1. /etc/mtab、/proc/self/mounts
1.3.2. /proc/self/mountinfo
1.3.3. bind mount
1.3.4. mount namespace简介
1.3.5. docker.sh
1.4. pid namespace
1.4.1. unshare的--fork选项
1.4.2. pid namespace简介
1.4.3. pid嵌套
1.4.4. docker.sh
2. CGroups
2.1. CGroups简介
2.2. 限制内存
2.2.1. 用CGroups限制内存
2.2.2. docker.sh
3. 切换根文件系统
3.1. 根文件系统
3.2. pivot_root
3.3. docker.sh
4. 联合加载
4.1. 联合加载简介
4.2. AUFS
4.3. docker.sh
5. 卷
5.1. 卷简介
5.2. docker.sh
6. 后记</code></pre></div></figure><h2 id="1-Namespace">1.Namespace</h2><h3 id="1-1-Namespace简介">1.1.Namespace简介</h3><p>传统上，在Linux中，许多资源是全局管理的。例如，系统中的所有进程按照惯例是通过PID标识的，这意味着内核必须管理一个全局的PID列表。而且，所有调用者通过uname系统调用返回的系统相关信息都是相同的。用户id的管理方式类似，即各个用户是通过一个全局唯一的UID标识。</p><p>Namespace是Linux用来隔离上述全局资源的一种方式。把一个或多个进程加入到同一个namespace中后，这些进程只会看到该namespace中的资源。namespace是后来加入到Linux中的，为了兼容之前的全局资源管理方式，Linux为每一种资源准备了一个全局的namespace。Linux中的每一个进程都默认加入了这些全局namespace。</p><p>Linux中的每个进程都有一个/proc/[pid]/ns/目录，里面包含了该进程所属的namespace信息。我们查看一下当前Shell的/proc/[pid]/ns目录，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ sudo ls -l /proc/$$/ns
total 0
lrwxrwxrwx 1 phl phl 0 Jan 22 08:43 cgroup -&gt; cgroup:[4026531835]
lrwxrwxrwx 1 phl phl 0 Jan 22 08:43 ipc -&gt; ipc:[4026531839]
lrwxrwxrwx 1 phl phl 0 Jan 22 08:43 mnt -&gt; mnt:[4026531840]
lrwxrwxrwx 1 phl phl 0 Jan 22 08:43 net -&gt; net:[4026531993]
lrwxrwxrwx 1 phl phl 0 Jan 22 08:43 pid -&gt; pid:[4026531836]
lrwxrwxrwx 1 phl phl 0 Jan 22 08:43 pid_for_children -&gt; pid:[4026531836]
lrwxrwxrwx 1 phl phl 0 Jan 22 08:43 user -&gt; user:[4026531837]
lrwxrwxrwx 1 phl phl 0 Jan 22 08:43 uts -&gt; uts:[4026531838]</code></pre></div></figure><p>该目录下有很多符号链接，每个符号链接代表一个该进程所属的namespace。用readlink读取这些符号链接可以查看进程所属的namespace id。我们读一下当前Shell所属的uts namespace id，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ sudo readlink /proc/$$/ns/uts
uts:[4026531838]</code></pre></div></figure><p>后文中我们将介绍uts namespace、mount namespace、pid namespace的用法。</p><h3 id="1-2-uts-namespace">1.2.uts namespace</h3><h4 id="1-2-1-uts-namespace简介">1.2.1.uts namespace简介</h4><p>uts namespace用于隔离系统的主机名等信息，我们将通过实验学习其用法。在实验过程中，我们采用如下的步骤：</p><ol><li>查看全局uts namespace信息</li><li>新建一个uts namespace，查看其信息并作出修改</li><li>查看全局uts namespace，查看其是否被新建的uts namespace影响到</li></ol><p>对于其他namespace，我们也采取类似的步骤进行实验学习。</p><p>首先，我们查看一下全局的hostname及uts namespace id。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ hostname
kernelnewbies

phl@kernelnewbies:~$ sudo readlink /proc/$$/ns/uts
uts:[4026531838]</code></pre></div></figure><p>然后，我们创建一个新的uts namespace，并查看其namespce id。</p><p>在继续之前，需要介绍一个namespace工具unshare。利用unshare我们可以新建一个的namespace，并在新namespace中执行一条命令。unshare执行时需要root权限。unshare的使用方法如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">unshare [options] [program [arguments]]</code></pre></div></figure><p>执行unshare时，我们可以指定要新建的namespace的类型以及要执行的命令。unshare提供了一系列选项，当指定某个选项时可新建指定的namespace。namespace类型选项如下：</p><ul><li>–uts创建新的uts namespace</li><li>–mount创建新的mount namespace</li><li>–pid创建新的pid namespace</li><li>–user创建新的user namespace</li></ul><p>介绍完unshare之后，我们继续之前的实验。我们用unshare创建一个新的uts namespace，并在新的uts namespace中执行/bin/bash命令，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ sudo unshare --uts /bin/bash
root@kernelnewbies:~#</code></pre></div></figure><p>我们用unshare创建了一个新的uts namespace。在新的uts namespace中查看其hostname和namespace id，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~$ hostname
kernelnewbies

root@kernelnewbies:~# readlink /proc/$$/ns/uts
uts:[4026532177]</code></pre></div></figure><p>从结果我们可以看到，新uts namespace的id与全局uts namespace的id不一致。这说明/bin/bash已运行在一个新的uts namespace中了。</p><p>我们将新uts namespace的hostname改为dreamland，并强制更新Shell提示符。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~# hostname dreamland
root@kernelnewbies:~# hostname
dreamland

root@kernelnewbies:~# exec /bin/bash
root@dreamland:~#</code></pre></div></figure><p>从结果我们可以看到，新uts namespace的hostname的确是被修改了，exec /bin/bash用于强制更新Shell的提示符。</p><p>我们重新打开一个Shell窗口，该Shell位于全局uts namespace中。在新的Shell窗口中查看全局uts namespace id及hostname，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ hostname
kernelnewbies

phl@kernelnewbies:~$ sudo readlink /proc/$$/ns/uts
uts:[4026531838]</code></pre></div></figure><p>从结果我们可以看到，我们在新uts namespace中所作的修改并未影响到全局的uts namespace。</p><p>父进程创建子进程时只有提供创建新namespace的标志，才可创建新的namespace，并使子进程处于新的namespace中。默认情况下，子进程与父进程处于相同的namespace中。我们在新的uts namespace中创建一个子进程，然后查看该子进程的uts namespace id，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ sudo unshare --uts /bin/bash
root@kernelnewbies:~# readlink /proc/$$/ns/uts
uts:[4026532305]

root@kernelnewbies:~# bash
root@kernelnewbies:~# readlink /proc/$$/ns/uts
uts:[4026532305]</code></pre></div></figure><p>从结果我们可以看到，子进程所属uts namespace的id与其父进程相同。其他namespae与uts namespace类似，子进程与父进程同属一个namespace。</p><h4 id="1-2-2-docker-sh"><a target="_blank" rel="noopener" href="http://1.2.2.docker.sh">1.2.2.docker.sh</a></h4><p>有了以上关于uts namespace的介绍，我们就可以将uts namespace加入到docker.sh中了。docker.sh工程分为两个脚本：<a target="_blank" rel="noopener" href="http://docker.xn--shcontainer-804s.sh">docker.sh和container.sh</a>。</p><p>docker.sh用于收集用户输入、调用unshare创建namespace并执行container.sh脚本，docker.sh脚本如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#!/bin/bash

usage () {
        echo -e "\033[31mIMPORTANT: Run As Root\033[0m"
        echo ""
        echo "Usage:    docker.sh [OPTIONS]"
        echo ""
        echo "A docker written by shell"
        echo ""
        echo "Options:"
        echo "          -c string       docker command"
        echo "                          (\"run\")"
        echo "          -m              memory"
        echo "                          (\"100M, 200M, 300M...\")"
        echo "          -C string       container name"
        echo "          -I string       image name"
        echo "          -V string       volume"
        echo "          -P string       program to run in container"

        return 0
}

if test "$(whoami)" != root
then
        usage
        exit -1
fi

while getopts c:m:C:I:V:P: option
do
        case "$option"
        in
                c) cmd=$OPTARG;;
                m) memory=$OPTARG;;
                C) container=$OPTARG;;
                I) image=$OPTARG;;
                V) volume=$OPTARG;;
                P) program=$OPTARG;;
                \?) usage
                    exit -2;;
        esac
done

export cmd=$cmd
export memory=$memory
export container=$container
export image=$image
export volume=$volume
export program=$program

unshare --uts ./container.sh</code></pre></div></figure><p>脚本最开始为usage函数，该函数为docker.sh的使用说明。当用户以非预期的方式使用docker.sh时，该函数会被调用。该函数输出如下信息：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">IMPORTANT: Run As Root

Usage:  docker.sh [OPTIONS]

A docker written by shell

Options:
                -c string       docker command
                                ("run")
                -m              memory
                                ("100M, 200M, 300M...")
                -C string       container name
                -I string       image name
                -V string       volume
                -P string       program to run in container</code></pre></div></figure><p>从usage函数的输出我们可以看到，执行docker.sh时需要root权限且需要正确地传递参数。</p><p>docker.sh首先对当前用户进行检测，如果用户不为root，则打印使用说明并退出脚本；如果用户为root，则继续执行。检测用户的脚本如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">if test "$(whoami)" != root
then
        usage
        exit -1
fi</code></pre></div></figure><p>然后，docker.sh使用getopts从命令行提取参数，然后赋值给合适的变量。从命令行提取参数的脚本如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">while getopts c:m:C:I:V:P: option
do
        case "$option"
        in
                c) cmd=$OPTARG;;
                m) memory=$OPTARG;;
                C) container=$OPTARG;;
                I) image=$OPTARG;;
                V) volume=$OPTARG;;
                P) program=$OPTARG;;
                \?) usage
                    exit -2;;
        esac
done</code></pre></div></figure><p>如果用户的输入不正确，则打印使用说明并退出脚本；如果用户输入正确，则解析命令行参数并赋值给合适的变量。</p><p>为了简化，用户在运行docker.sh时需提供完整的参数列表，示例如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash</code></pre></div></figure><p>当然，如果当前用户就是root，就不需要sudo了。下表列出了各个参数的含义及示例：</p><p><img src="https://cimg1.17lai.site/data/2022/03/1820220318143125.png" srcset="/medias_webp/loading2.svg" loading="lazy" lazyload alt="使用 Shell 脚本实现 Docker"></p><p>docker.sh将命令行参数赋值给变量后，需要将这些变量导出，<a target="_blank" rel="noopener" href="http://xn--container-927njum596bv1yb.sh">以传递给container.sh</a>。导出变量的脚本如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">export cmd=$cmd
export memory=$memory
export container=$container
export image=$image
export volume=$volume
export program=$program</code></pre></div></figure><p>这里说明一下为什么要将docker.sh工程拆分为docker.sh和container.sh两个脚本。因为调用unshare创建新的namespace时，会执行一个命令，该命令在新的namespace中运行。该命令一旦结束，unshare也就结束了，unshare创建的新namespace也就不存在了。</p><p>docker.sh不会并发地执行unshare命令与unshare之后的脚本，因此，只有unshare结束了，后续脚本才可继续运行。但是当unshare结束了，准备执行后续脚本时，新的namespae已经不存在了。因此一些加入cgroups、切换根文件系统等工作必须在unshare执行的命令中进行，所以我们采用在unshare中执行container.sh脚本的方式完成后续的工作。</p><p>最后，docker.sh调用unshare创建新的uts namespace，并执行container.sh脚本。调用unshare的脚本如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">unshare --uts ./container.sh</code></pre></div></figure><p>container.sh将容器的hostname修改为通过-C传递的容器的名字，然后执行通过-P传递的程序。container.sh脚本如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#!/bin/bash

hostname $container
exec $program</code></pre></div></figure><p>现在，<a target="_blank" rel="noopener" href="http://xn--docker-hz8i102ky51eyyp.sh">我们运行docker.sh</a>，并查看其hostname。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ sudo ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
root@dreamland:~/docker.sh# hostname
dreamland</code></pre></div></figure><p>从结果我们可以看到，容器的hostname已经改变为我们传递的容器名字dreamland了。</p><h3 id="1-3-mount-namespace">1.3.mount namespace</h3><h4 id="1-3-1-etc-mtab、-proc-self-mounts">1.3.1./etc/mtab、/proc/self/mounts</h4><p>早期的Linux使用/etc/mtab文件来记录当前的挂载点信息。每次mount/umount文件系统时会更新/etc/mtab文件中的信息。</p><p>后来，linux引入了mount namespace，每个进程都有一份自己的挂载点信息。当然，处于同一个mount namespace里面的进程，其挂载点信息是相同的。进程的挂载点信息通过/proc/[pid]/mounts文件导出给用户。</p><p>为了兼容以前的/etc/mtab，/etc/mtab变成了指向/proc/self/mounts的符号链接。通过readlink查看/etc/mtab指向的文件，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ readlink /etc/mtab
../proc/self/mounts</code></pre></div></figure><p>通过读取/proc/self/mounts文件，可以查看当前的挂载点信息，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ cat /proc/self/mounts
sysfs /sys sysfs rw,nosuid,nodev,noexec,relatime 0 0
proc /proc proc rw,nosuid,nodev,noexec,relatime 0 0
/dev/sda1 / ext4 rw,relatime,errors=remount-ro 0 0
securityfs /sys/kernel/security securityfs rw,nosuid,nodev,noexec,relatime 0 0
...</code></pre></div></figure><p>由于该文件中内容太多，我们省略了一部分，只保留了一些比较重要的挂载点信息。每行的信息分为六个字段，各字段的含义及示例如下：</p><p><img src="https://cimg1.17lai.site/data/2022/03/1820220318143143.png" srcset="/medias_webp/loading2.svg" loading="lazy" lazyload alt="使用 Shell 脚本实现 Docker"></p><p>由于该文件有点过时，被后文介绍的/proc/self/mountinfo替换掉，所以不做过多介绍。</p><h4 id="1-3-2-proc-self-mountinfo">1.3.2./proc/self/mountinfo</h4><p>/proc/self/mountinfo包含了进程mount namespace中的挂载点信息。 它提供了旧的/proc/[pid]/mounts文件中缺少的各种信息（传播状态，挂载点id，父挂载点id等），并解决了/proc/[pid]/mounts文件的一些其他缺陷。我们查看进程挂载点信息时应优先使用该文件。</p><p>该文件中每一行代表一个挂载点信息，每个挂载点信息分为11个字段。挂载点信息的示例如下：</p><p><img src="https://cimg1.17lai.site/data/2022/03/1820220318143124.png" srcset="/medias_webp/loading2.svg" loading="lazy" lazyload alt="使用 Shell 脚本实现 Docker"></p><p>各字段的含义及示例如下：</p><p><img src="https://cimg1.17lai.site/data/2022/03/1820220318143118.png" srcset="/medias_webp/loading2.svg" loading="lazy" lazyload alt="使用 Shell 脚本实现 Docker"></p><p>我们主要关注可选字段中的传播状态选项。首先，我们看一下关于mount namespace的问题。问题如下：</p><p>当创建mount namespace时，新mount namespace会拷贝一份老mount namespace里面的挂载点信息。例如，全局mount namespace中有一个/a挂载点，新建的mount namespace中也会有一个/a挂载点。那么我们在新mount namespace中的/a下创建或删除一个挂载点，全局mount namespace中的/a会同步创建或删除该挂载点吗？或者在全局mount namespace中的/a下创建或删除一个挂载点，新mount namespace中的/a会同步创建或删除该挂载点吗？</p><p>mountinfo文件中可选字段的传播状态就是控制在一个挂载点下进行创建/删除挂载点操作时是否会传播到其他挂载点的选项。传播状态有四种可取值，常见的有如下两种：</p><ul><li>shared 表示创建/删除挂载点的操作会传播到其他挂载点</li><li>private 表示创建/删除挂载点的操作不会传播到其他挂载点</li></ul><p>由于在容器技术中要保证主机与容器的挂载点信息互不影响，因此要求容器中的挂载点的传播状态为private。</p><h4 id="1-3-3-bind-mount">1.3.3.bind mount</h4><p>bind mount可以将一个目录（源目录）挂载到另一个目录（目的目录），在目的目录里面的读写操作将直接作用于源目录。</p><p>下面我们通过实验了解一下bind mount的功能，首先，我们准备一下实验所需要的的目录及文件。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ mkdir bind
phl@kernelnewbies:~$ cd bind/
phl@kernelnewbies:~/bind$ mkdir a
phl@kernelnewbies:~/bind$ mkdir b
phl@kernelnewbies:~/bind$ echo hello, a &gt; a/a.txt
phl@kernelnewbies:~/bind$ echo hello, b &gt; b/b.txt</code></pre></div></figure><p>然后，我们将a目录bind mount到b目录并查看b目录下的内容。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/bind$ sudo mount --bind a b
phl@kernelnewbies:~/bind$ tree b
b
└── a.txt
0 directories, 1 file</code></pre></div></figure><p>从结果我们可以看到，b目录下原先的内容被隐藏，取而代之的是a目录下的内容。</p><p>然后，我们修改b目录下的内容，修改完毕后，从b目录上卸载掉a目录。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/bind$ echo hello, a from b &gt; b/a.txt
phl@kernelnewbies:~/bind$ sudo umount b</code></pre></div></figure><p>我们读取一下a目录中a.txt，看看其内容是否被改变。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/bind$ cat a/a.txt
hello, a from b</code></pre></div></figure><p>从结果我们可以看到，a目录中的内容确实被当a被bind mount到b时对b目录的操作所修改了。</p><p>bind mount在容器技术中有很重要的用途，后文会有涉及。</p><h4 id="1-3-4-mount-namespace简介">1.3.4.mount namespace简介</h4><p>mount namespace用来隔离文件系统的挂载点信息, 使得不同的mount namespace拥有自己独立的挂载点信息。不同的namespace之间不会相互影响，其在unshare中的选项为–mount。</p><p>当用unshare创建新的mount namespace时，新创建的namespace将拷贝一份老namespace里的挂载点信息，但从这之后，他们就没有关系了。这是unshare将新 namespace 里面的所有挂载点的传播状态设置为private实现的。通过mount和umount增加和删除各自mount namespace里面的挂载点都不会相互影响。</p><p>下面我们将演示mount namespace的用法。首先，我们准备需要的目录和文件，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ mkdir -p hds/hd1 hds/hd2 &amp;&amp; cd hds

phl@kernelnewbies:~/hds$ dd if=/dev/zero bs=1M count=1 of=hd1.img &amp;&amp; mkfs.ext2 hd1.img
phl@kernelnewbies:~/hds$ dd if=/dev/zero bs=1M count=1 of=hd2.img &amp;&amp; mkfs.ext2 hd2.img

phl@kernelnewbies:~$ tree .
.
├── hd1
├── hd1.img
├── hd2
└── hd2.img
2 directories, 2 files</code></pre></div></figure><p>然后，我们在全局的mount namespace中挂载hd1.img到hd1目录，然后查看该mount namespace中的挂载点信息与mount namespace id。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/hds$ sudo mount hd1.img hd1
phl@kernelnewbies:~/hds$ cat /proc/self/mountinfo | grep hd
556 27 7:18 / /home/phl/hds/hd1 rw,relatime shared:372 - ext2 /dev/loop18 rw

phl@kernelnewbies:~/hds$ sudo readlink /proc/$$/ns/mnt
mnt:[4026531840]</code></pre></div></figure><p>然后，执行unshare命令创建一个新的mount namespace并查看该mount namespace id和挂载点信息。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/hds$ sudo unshare --uts --mount /bin/bash
root@kernelnewbies:~/hds# cat /proc/self/mountinfo | grep hd
739 570 7:18 / /home/phl/hds/hd1 rw,relatime - ext2 /dev/loop18 rw

root@kernelnewbies:~/hds# readlink /proc/$$/ns/mnt
mnt:[4026532180]</code></pre></div></figure><p>从结果我们可以看到，新mount namespace中的挂载点信息与全局mountnamespace中的挂载点信息基本一致，一些挂载选项（如传播状态）变化了。新的mount namespace id与全局mount namespace id是不一样的。</p><p>然后，我们在新的mount namespace中挂载hd2.img到hd2目录，并查看挂载点信息。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/hds# mount hd2.img hd2
root@kernelnewbies:~/hds# cat /proc/self/mountinfo | grep hd
739 570 7:18 / /home/phl/hds/hd1 rw,relatime - ext2 /dev/loop18 rw
740 570 7:19 / /home/phl/hds/hd2 rw,relatime - ext2 /dev/loop19 rw</code></pre></div></figure><p>从结果我们可以看到，新mount namespace中有hd1和hd2这两个挂载点。现在启动一个新的Shell窗口，查看全局mount namespace中的挂载点信息。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/hds$ cat /proc/self/mountinfo | grep hd
556 27 7:18 / /home/phl/hds/hd1 rw,relatime shared:372 - ext2 /dev/loop18 rw</code></pre></div></figure><p>从结果我们可以看到，全局mount namespace中的挂载点信息只有hd1，而没有hd2。这说明在新mount namespace中进行挂载/卸载操作不会影响其他mount namespace中的挂载点信息。</p><p>mount namespace只隔离挂载点信息，并不隔离挂载点下面的文件信息。对于多个mount namespace都能看到的挂载点，如果在一个namespace中修改了挂载点下面的文件，其他namespace也能感知到。下面，我们在新建的mount namespace中创建一个文件，命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/hds# echo hello from new mount namespace &gt; hd1/hello.txt</code></pre></div></figure><p>在新启动的Shell中，查看hd1目录并读取hd1/hello.txt文件。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/hds$ tree hd1
hd1
├── hello.txt
└── lost+found [error opening dir]
1 directory, 1 file

phl@kernelnewbies:~/hds$ cat hd1/hello.txt
hello from new mount namespace</code></pre></div></figure><p>从结果我们可以看到，在全局mount namespace中，我们可以读取到在新建的mount namespace中创建的文件。</p><h4 id="1-3-5-docker-sh"><a target="_blank" rel="noopener" href="http://1.3.5.docker.sh">1.3.5.docker.sh</a></h4><p>有了以上关于mount namespace的知识，我们就可以将mount namespace加入到docker.sh中了。mount namespace将放在docker.sh中，带下划线的行是我们为实现mount namespace而修改的代码。修改后的docker.sh脚本如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">...
unshare --uts --mount ./container.sh</code></pre></div></figure><p>从上述代码我们可以看到，我们仅仅是在调用unshare时加入–mount选项，就可为docker.sh引入了mount namespace功能。</p><h3 id="1-4-pid-namespace">1.4.pid namespace</h3><h4 id="1-4-1-unshare的–fork选项">1.4.1.unshare的–fork选项</h4><p>unshare有一个选项–fork，当执行unshare时，如果没有这个选项，unshare会直接exec新命令，也就是说unshare变成了新命令。如果带有–fork选项，unshare会fork一个子进程，该子进程exec新命令，unshare是该子进程的父进程。我们分别不带–fork和带–fork来执行unshare，然后查看进程之间的关系。</p><p>首先，我们不带–fork选项执行unshare，并查看当前Shell的进程id。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ sudo unshare --uts /bin/bash
root@kernelnewbies:~/hds# echo $$
11699</code></pre></div></figure><p>此时unshare会创建一个新的uts namespace，然后exec /bin/bash。我们启动一个新Shell，然后使用pstree查看进程间关系，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/hds$ pstree -p | grep 11699
sudo(11698)---bash(11699)</code></pre></div></figure><p>从结果我们可以看到，sudo fork出一个子进程，该子进程执行unshare。unshare创建了新uts namespace后，exec了/bin/bash，也就是说unshare变成了/bin/bash。</p><p>然后，我们带–fork选项执行unshare，并查看当前Shell的进程id。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/hds$ sudo unshare --uts --fork /bin/bash
root@kernelnewbies:~/hds# echo $$
11866</code></pre></div></figure><p>此时unshare会创建一个新的uts namespace，然后fork出一个子进程，该子进程exec /bin/bash。我们启动一个新Shell，然后使用pstree查看进程间关系，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/hds$ pstree -p | grep 11866
sudo(11864)---unshare(11865)---bash(11866)</code></pre></div></figure><p>从结果我们可以看到，sudo fork出一个子进程，该子进程执行命令unshare。unshare创建了新uts namespace后，fork出一个子进程，该子进程exec /bin/bash，也就是说unshare变成了新的/bin/bash进程的父进程。</p><h4 id="1-4-2-pid-namespace简介">1.4.2.pid namespace简介</h4><p>pid namespace用来隔离进程pid空间，使得不同pid namespace里的进程 pid可以重复且相互之间不影响。进程所属的pid namespace在创建的时候就确定了，无法更改，因此需要–fork选项来创建一个新进程，然后将该新进程加入新建的pid namespace中。pid namespace在unshare中的选项为–pid。</p><p>unshare在创建pid namespace时需同时提供–pid与–fork选项。unshare本身会加入全局的pid namespace，其fork出的子进程会加入新建的pid namespace。</p><p>首先，我们查看全局pid namespace id，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ sudo readlink /proc/$$/ns/pid
pid:[4026531836]</code></pre></div></figure><p>然后，执行unshare命令创建一个新的pid namespace并查看该pid namespace id。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ sudo unshare --mount --pid --fork /bin/bash
root@kernelnewbies:~# readlink /proc/$$/ns/pid
pid:[4026531836]</code></pre></div></figure><p>从结果我们可以看到，新创建的进程也处于全局pid namespace中，而不是新的pid namespace。</p><p>出现这种情形是因为当前的/proc文件系统是老的。我们查看一下$$的值，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~# echo $$
1</code></pre></div></figure><p>从结果我们可以看到，$$的值为1，但是/proc文件系统却是老的，因此我们查看的实际是init进程所属的pid namespace，当然是全局pid namespace了。</p><p>重新挂载/proc文件系统，这也是unshare执行时带–mount选项的原因，只有这样，重新挂载/proc文件系统时，不会搞乱整个系统。再次查看新进程所属的pid namespace，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~# mount -t proc proc /proc
root@kernelnewbies:~# readlink /proc/$$/ns/pid
pid:[4026532182]</code></pre></div></figure><p>从结果我们可以看到，新进程的pid namespace与全局pid namespace的id不同。</p><p>接下来，我们再来查看一下新pid namespace中的进程信息。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~# ps -ef
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 19:03 pts/1    00:00:00 /bin/bash
root        10     1  0 19:03 pts/1    00:00:00 ps -e</code></pre></div></figure><p>从结果我们可以看到，当前pid namespace中只有2个进程，看不到全局pid namespace里面的其他进程。我们通过unshare执行的进程pid为1，也就是说该进程成了新pid namespace中的init进程。</p><h4 id="1-4-3-pid嵌套">1.4.3.pid嵌套</h4><p>pid namespace可以嵌套，也就是说有父子关系，在当前pid namespace里面创建的所有新的pid namespace都是当前pid namespace的子pid namespace。</p><p>首先，我们创建3个嵌套的pid namespace，并查看每个pid namespace id。–mount-proc选项用于自动挂载/proc文件系统，省去了手动挂载/proc文件系统的操作。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ sudo readlink /proc/$$/ns/pid
pid:[4026531836]

phl@kernelnewbies:~$ sudo unshare --uts --mount --pid --mount-proc --fork /bin/bash
root@kernelnewbies:~# readlink /proc/$$/ns/pid
pid:[4026532182]

root@kernelnewbies:~# unshare --uts --mount --pid --mount-proc --fork /bin/bash
root@kernelnewbies:~# readlink /proc/$$/ns/pid
pid:[4026532185]

root@kernelnewbies:~# unshare --uts --mount --pid --mount-proc --fork /bin/bash
root@kernelnewbies:~# readlink /proc/$$/ns/pid
pid:[4026532188]</code></pre></div></figure><p>然后，我们启动一个新Shell，然后使用pstree查看进程间关系。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ pstree -lp | grep unshare
sudo(12547)---unshare(12548)---bash(12549)---unshare(12579)---bash(12580)---unshare(12593)---bash(12594)</code></pre></div></figure><p>使用cat /proc/[pid]/status | grep NSpid可查看某进程在当前pid namespace及子孙pid namespace中的pid。我们在全局pid namespace中查看上述各进程在各pid namespace中的pid，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ cat /proc/12594/status | grep NSpid
NSpid: 12594 21 11 1

phl@kernelnewbies:~$ cat /proc/12593/status | grep NSpid
NSpid: 12593 20 10

phl@kernelnewbies:~$ cat /proc/12580/status | grep NSpid
NSpid: 12580 11 1

phl@kernelnewbies:~$ cat /proc/12579/status | grep NSpid
NSpid: 12579 10

phl@kernelnewbies:~$ cat /proc/12549/status | grep NSpid
NSpid: 12549 1</code></pre></div></figure><p>下面我们将以上进程在各pid namespace中的pid，整理成表格。表格信息如下：</p><p><img src="https://cimg1.17lai.site/data/2022/03/1820220318143156.png" srcset="/medias_webp/loading2.svg" loading="lazy" lazyload alt="使用 Shell 脚本实现 Docker"></p><p>我们以最后一行为例进行介绍，最后一行有4个pid，这4个pid其实是同一个进程。这个进程在4个pid namespace中都可以被看到，且其在4个pid namespace中的pid各不相同。</p><h4 id="1-4-4-docker-sh"><a target="_blank" rel="noopener" href="http://1.4.4.docker.sh">1.4.4.docker.sh</a></h4><p>有了以上关于pid namespace的知识，我们就可以将pid namespae加入到docker.sh中了。pid namespace将放在docker.sh中，带下划线的行是我们为实现pid namespace而修改的代码。修改后的docker.sh脚本如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">...
unshare --uts --mount --pid --fork ./container.sh</code></pre></div></figure><p>从上述代码我们可以看到，我们仅仅是在调用unshare时加入–pid和–fork选项，就可为docker.sh引入了pid namespace功能。</p><p>然后，我们需要重新挂载/proc文件系统。重新挂载/proc文件系统的功能将放在container.sh中，带下划线的行是我们为重新挂载/proc文件系统而新添的代码。修改后的container.sh脚本如下如下所示：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hostname $container
mount -t proc proc /proc
exec $program</code></pre></div></figure><p>现在，<a target="_blank" rel="noopener" href="http://xn--docker-hz8i102ky51eyyp.sh">我们运行docker.sh</a>，并查看当前的进程信息。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ sudo ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
root@dreamland:~/docker.sh# ps -ef
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 17:31 pts/1    00:00:00 /bin/bash
root        16     1  0 17:31 pts/1    00:00:00 ps -ef</code></pre></div></figure><p>从结果我们可看出，当前进程只有两个，不再有主机上的其他进程。</p><h2 id="2-CGroups">2.CGroups</h2><h3 id="2-1-CGroups简介">2.1.CGroups简介</h3><p>CGroups是一种将进程分组，并以组为单位对进程实施资源限制的技术。每个组都包含以下几类信息：</p><ul><li>进程列表</li><li>资源A限制</li><li>资源B限制</li><li>资源C限制</li><li>…</li></ul><p>我们将以常见的CPU资源及内存资源为例进行介绍。以下的信息将使进程号为1001、1002、2008、3306的四个进程总共只能使用一个CPU核心；总共最多使用25%的CPU资源；总共最多使用100M内存，这样的一个分组被称为cgroup。</p><p><img src="https://cimg1.17lai.site/data/2022/03/1820220318143103.png" srcset="/medias_webp/loading2.svg" loading="lazy" lazyload alt="使用 Shell 脚本实现 Docker"></p><p>上面的介绍只是说明了要将何种资源限制施加于哪些进程，并未说明资源限制是如何施加到进程上。具体施加资源限制的过程需要subsystem来帮忙。subsystem读取cgroup中的资源限制和进程列表，然后将这些资源限制施加到这些进程上。常见的subsystem包括如下几种：</p><ul><li>cpu</li><li>memory</li><li>pids</li><li>devices</li><li>blkio</li><li>net_cls</li></ul><p>每个subsystem只读取与其相关的资源限制，然后施加到进程上。例如：memory子系统只读取内存限制，而cpu子系统只读取cpu限制。</p><p>cgroup被组织成树，如下图所示：</p><p><img src="https://cimg1.17lai.site/data/2022/03/1820220318143057.png" srcset="/medias_webp/loading2.svg" loading="lazy" lazyload alt="使用 Shell 脚本实现 Docker"></p><p>采用树状结构可以方便地实现资源限制继承，一个cgroup中的资源限制将作用于该cgroup及其子孙cgroup中的进程。例如：图中13001、10339、2999受到A、B、C、D四个cgroup中的资源限制。这样的一个树状结构被称为hierarchy。</p><p>hierarchy中包含了系统中所有的进程，它们分布于各个cgroup中。在hierarchy中，一个进程必须属于且只属于一个cgroup，这样才能保证对进程施加的资源限制不会遗漏也不会冲突。</p><p>要想让一个subsystem读取hierarchy中各cgroup的资源限制，并施加于其中的进程需要将subsystem和hierarchy关联起来。subsystem与hierarchy的关系如下：</p><ul><li>系统中可以有多个hierarchy</li><li>一个hierarchy可以关联0个或多个subsystem，当关联0个subsystem时，该hierarchy只是对进程进行分类</li><li>一个subsystem最多关联到一个hierarchy，因为每个hierarchy都包含系统中所有的进程，若一个subsystem关联到了多个hierarchy，对同一进程将有多种资源限制，这是不对的</li></ul><p>系统使用CGroups通常有两种形式：一种是创建一个hierarchy，将所有的subsystem关联到其上，在这个hierarchy上配置各种资源限制；另一种是为每一个subsystem创建一个hierarchy，并将该subsystem关联到其上，每个hierarchy只对一种资源进行限制。后一种比较清晰，得到了更普遍的采用。</p><p>CGroups不像大多数的技术那样提供API或命令之类的用户接口，而是提供给用户一个虚拟文件系统，该虚拟文件系统类型为cgroup。一个挂载后的cgroup文件系统就是一个hierarchy，文件系统中的一个目录就是一个cgroup，目录中的文件代表了进程列表或者资源限制信息。文件系统是树状结构，其各个目录之间的父子关系就代表了cgroup之间的继承关系。挂载cgroup虚拟文件系统后，通过在该文件系统上创建目录、写进程列表文件、写资源限制文件就可以操作CGroups。</p><p>下面，我们通过实验学习一下CGroups的用法。首先，我们挂载一个cgroup虚拟文件系统，该文件系统不与任何subsystem关联，仅仅是将进程进行分类。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ mkdir -p cg/test
# -o none,name=test 表示该cgroup文件系统不与任何子系统关联
# 该文件系统用name=test来标识
phl@kernelnewbies:~$ sudo mount -t cgroup -o none,name=test test cg/test
phl@kernelnewbies:~$ tree cg/test
cg/test
├── cgroup.clone_children
├── cgroup.procs
├── cgroup.sane_behavior
├── notify_on_release
├── release_agent
└── tasks
0 directories, 6 files</code></pre></div></figure><p>挂载cgroup文件系统后，该cgroup文件系统的根目录下会生成许多文件，该根目录被称为root cgroup。cgroup.procs里面存放的是当前cgroup中的所有进程id，由于该hierarchy中只有一个cgroup，所以这个文件包含了系统中所有的进程id。其他的文件与cgroups基本功能关系不大，暂时可以忽略。</p><p>在cgroup文件系统中，创建一个目录就会创建一个cgroup。下面我们将会演示如何创建下面这样的hierarchy：</p><p><img src="https://cimg1.17lai.site/data/2022/03/1820220318143054.png" srcset="/medias_webp/loading2.svg" loading="lazy" lazyload alt="使用 Shell 脚本实现 Docker"></p><p>命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ sudo mkdir -p cg/test/test1/test11
phl@kernelnewbies:~$ sudo mkdir -p cg/test/test2/test22
phl@kernelnewbies:~$ tree cg/test
cg/test
├── cgroup.clone_children
├── cgroup.procs
├── cgroup.sane_behavior
├── notify_on_release
├── release_agent
├── tasks
├── test1
│   ├── cgroup.clone_children
│   ├── cgroup.procs
│   ├── notify_on_release
│   ├── tasks
│   └── test11
│       ├── cgroup.clone_children
│       ├── cgroup.procs
│       ├── notify_on_release
│       └── tasks
└── test2
    ├── cgroup.clone_children
    ├── cgroup.procs
    ├── notify_on_release
    ├── tasks
    └── test22
        ├── cgroup.clone_children
        ├── cgroup.procs
        ├── notify_on_release
        └── tasks

4 directories, 22 files</code></pre></div></figure><p>从结果我们可以看到，我们创建了相应的目录后，这些目录下自动出现了包含cgroup信息的目录及文件。</p><p>删除cgroup时只需删除该cgroup所在的目录即可。下面我们将删除test11 cgroup，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ sudo rmdir cg/test/test1/test11
phl@kernelnewbies:~$ tree cg/test
cg/test
├── cgroup.clone_children
├── cgroup.procs
├── cgroup.sane_behavior
├── notify_on_release
├── release_agent
├── tasks
├── test1
│   ├── cgroup.clone_children
│   ├── cgroup.procs
│   ├── notify_on_release
│   └── tasks
└── test2
    ├── cgroup.clone_children
    ├── cgroup.procs
    ├── notify_on_release
    ├── tasks
    └── test22
        ├── cgroup.clone_children
        ├── cgroup.procs
        ├── notify_on_release
        └── tasks

3 directories, 18 files</code></pre></div></figure><p>每个cgroup下面都有一个cgroup.procs文件，该文件里面包含当前cgroup里面的所有进程id。只要将某个进程的id写入该文件，即可将该进程加入到该cgroup中。下面，我们将当前的bash加入到test22 cgroup中，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ echo $$
3894
phl@kernelnewbies:~$ sudo sh -c "echo 3894 &gt; cg/test/test2/test22/cgroup.procs"</code></pre></div></figure><p>/proc/[pid]/cgroup包含了某个进程所在的cgroup信息。下面，我们查看一下当前bash进程所在的cgroup信息，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ cat /proc/3894/cgroup
13:name=test:/test2/test22
12:freezer:/
11:perf_event:/
10:blkio:/user.slice
9:devices:/user.slice
8:hugetlb:/
7:cpu,cpuacct:/user.slice
6:net_cls,net_prio:/
5:memory:/user.slice
4:rdma:/
3:pids:/user.slice/user-1001.slice/session-4.scope
2:cpuset:/
1:name=systemd:/user.slice/user-1001.slice/session-4.scope
0::/user.slice/user-1001.slice/session-4.scope</code></pre></div></figure><p>从结果我们可以看到，当前bash进程加入了多个cgroup，其中带下划线的行为我们刚刚加入的cgroup。</p><p>要想将hierarchy与子系统关联起来，需要在-o选项中指定子系统名称。下面演示了如何将memory子系统与新挂载的cgroup文件系统关联起来。代码如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ sudo mkdir cg/memory
phl@kernelnewbies:~$ sudo mount -t cgroup -o memory memcg cg/memory</code></pre></div></figure><p>由于很多发行版的操作系统已经为我们配置好了这些cgroup文件系统，我们应当直接使用这些已经挂在好的文件系统，不需要自己去挂载。</p><p>另外，当创建子进程时，子进程会自动加入父进程所在的cgroup。</p><h3 id="2-2-限制内存">2.2.限制内存</h3><h4 id="2-2-1-用CGroups限制内存">2.2.1.用CGroups限制内存</h4><p>下面我们将介绍演示CGroups如何限制进程使用的内存资源，我们以内存为例进行讲解。</p><p>Ubuntu18.04已经为我们挂载了一个关联memory子系统的cgroup虚拟文件系统。我们用mount命令查看一下该系统挂载到了何处，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ mount | grep cgroup
tmpfs on /sys/fs/cgroup type tmpfs (ro,nosuid,nodev,noexec,mode=755)
cgroup on /sys/fs/cgroup/unified type cgroup2 (rw,nosuid,nodev,noexec,relatime,nsdelegate)
cgroup on /sys/fs/cgroup/systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,name=systemd)
cgroup on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)
cgroup on /sys/fs/cgroup/pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)
cgroup on /sys/fs/cgroup/rdma type cgroup (rw,nosuid,nodev,noexec,relatime,rdma)
cgroup on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)
cgroup on /sys/fs/cgroup/net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls,net_prio)
cgroup on /sys/fs/cgroup/cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpu,cpuacct)
cgroup on /sys/fs/cgroup/hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)
cgroup on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)
cgroup on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)
cgroup on /sys/fs/cgroup/perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)
cgroup on /sys/fs/cgroup/freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)</code></pre></div></figure><p>该系统挂载到了/sys/fs/cgroup/memory目录下。我们在该hierarchy中创建一个test cgroup并查看该cgroup的目录结构，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ sudo mkdir /sys/fs/cgroup/memory/test
phl@kernelnewbies:~$ tree /sys/fs/cgroup/memory/test
/sys/fs/cgroup/memory/test
├── cgroup.clone_children
├── cgroup.event_control
├── cgroup.procs
├── memory.failcnt
├── memory.force_empty
├── memory.kmem.failcnt
├── memory.kmem.limit_in_bytes
├── memory.kmem.max_usage_in_bytes
├── memory.kmem.slabinfo
├── memory.kmem.tcp.failcnt
├── memory.kmem.tcp.limit_in_bytes
├── memory.kmem.tcp.max_usage_in_bytes
├── memory.kmem.tcp.usage_in_bytes
├── memory.kmem.usage_in_bytes
├── memory.limit_in_bytes
├── memory.max_usage_in_bytes
├── memory.move_charge_at_immigrate
├── memory.numa_stat
├── memory.oom_control
├── memory.pressure_level
├── memory.soft_limit_in_bytes
├── memory.stat
├── memory.swappiness
├── memory.usage_in_bytes
├── memory.use_hierarchy
├── notify_on_release
└── tasks
0 directories, 27 files</code></pre></div></figure><p>从结果我们可以看到，新建的test cgroup中有许多文件，这些文件中存放着资源限制信息。其中memory.limit_in_bytes里面存放的是该cgroup中的进程能够使用的内存额度。</p><p>下面，我们将当前bash加入到test cgroup中并查看当前bash所属的cgroup信息。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ echo $$
2984
phl@kernelnewbies:~$ sudo sh -c "echo 2984 &gt; /sys/fs/cgroup/memory/test/cgroup.procs"
phl@kernelnewbies:~$ cat /proc/2984/cgroup
12:devices:/user.slice
11:hugetlb:/
10:memory:/test
9:rdma:/
8:perf_event:/
7:blkio:/user.slice
6:cpu,cpuacct:/user.slice
5:pids:/user.slice/user-1001.slice/session-4.scope
4:freezer:/
3:cpuset:/
2:net_cls,net_prio:/
1:name=systemd:/user.slice/user-1001.slice/session-4.scope
0::/user.slice/user-1001.slice/session-4.scope</code></pre></div></figure><p>从结果我们可以看到，当前bash所属的memory cgroup变为了/test，该目录为一个相对于root cgroup的相对路径。</p><p>然后，将100M写入test cgroup中的memory.limit_in_bytes文件中，命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ sudo sh -c "echo 100M &gt; /sys/fs/cgroup/memory/test/memory.limit_in_bytes"</code></pre></div></figure><p>我们在当前bash中启动一个占用300M进程的stress进程，该stress进程是bash的子进程，其与bash进程都在test cgroup中。命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ stress --vm 1 --vm-bytes 300M --vm-keep</code></pre></div></figure><p>启动一个新的Shell窗口，执行top命令查看stress进程占用的内存。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
14216 root      20   0  315440 101224    264 D 27.7  2.5   0:02.66 stress</code></pre></div></figure><p>从结果我们可以看到，stress进程占用了2.5%的内存。我的电脑的内存为4G，4G * 2.5% = 100M，stress进程确实受到了cgroup中设置的内存额度的限制。</p><h4 id="2-2-2-docker-sh"><a target="_blank" rel="noopener" href="http://2.2.2.docker.sh">2.2.2.docker.sh</a></h4><p>下有了以上关于CGroups的知识，我们就可以将限制内存的功能加入到docker.sh中了。限制内存的功能将放在container.sh中，带下划线的行是我们为实现限制内存而新添的代码。修改后的container.sh脚本如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hostname $container
mkdir -p /sys/fs/cgroup/memory/$container
echo $$ &gt; /sys/fs/cgroup/memory/$container/cgroup.procs
echo $memory &gt; /sys/fs/cgroup/memory/$container/memory.limit_in_bytes
mount -t proc proc /proc
exec $program</code></pre></div></figure><p>首先，我们根据容器的名字创建cgroup，命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mkdir -p /sys/fs/cgroup/memory/$container</code></pre></div></figure><p>然后，我们将当前bash加入到我们创建的cgroup中，命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">echo $$ &gt; /sys/fs/cgroup/memory/$container/cgroup.procs</code></pre></div></figure><p>最后，我们将内存限制写入新cgroup的memory.limit_in_bytes文件中，命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">echo $memory &gt; /sys/fs/cgroup/memory/$container/memory.limit_in_bytes</code></pre></div></figure><p>现在，<a target="_blank" rel="noopener" href="http://xn--docker-hz8i102ky51eyyp.sh">我们运行docker.sh</a>，并启动一个占用300M进程的stress进程。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ sudo ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
root@dreamland:~/docker.sh# stress --vm 1 --vm-bytes 300M --vm-keep
stress: info: [12] dispatching hogs: 0 cpu, 0 io, 1 vm, 0 hdd</code></pre></div></figure><p>启动一个新的Shell窗口，执行top命令查看stress进程占用的内存。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
14216 root      20   0  315440 101224    264 D 27.7  2.5   0:02.66 stress</code></pre></div></figure><p>从结果我们可以看到，容器内的stress进程只使用了100M的内存。</p><h2 id="3-切换根文件系统">3.切换根文件系统</h2><h3 id="3-1-根文件系统">3.1.根文件系统</h3><p>在容器技术中，根文件系统可为容器进程提供一个与主机不一致的文件系统环境。举个例子，主机为Ubuntu 18.04，创建的容器采用Ubuntu 16.04的根文件系统，那么容器运行时所用的软件及其依赖库、配置文件等都是Ubuntu 16.04的。尽管该容器使用的内核是仍旧是Ubuntu 18.04的，但应用软件的表现却与Ubuntu 16.04一致，从虚拟化的角度来说该容器就是一个Ubuntu 16.04系统。</p><p>debootstrap是Ubuntu下的一个工具，用来构建根文件系统。生成的目录符合Linux文件系统标准，即包含了/boot、/etc、/bin、/usr等目录。debootstrap的安装命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sudo apt install debootstrap</code></pre></div></figure><p>下面我们通过debootstrap构建Ubuntu 16.04的根文件系统。为了清晰，我们在images目录下生成根文件系统。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ mkdir images
phl@kernelnewbies:~/docker.sh$ cd images
phl@kernelnewbies:~/docker.sh/images$ sudo debootstrap --arch amd64 xenial ./ubuntu1604</code></pre></div></figure><p>制作根文件系统需要从服务器下载很多文件，很耗时，请耐心等待。当文件系统制作好后，可以使用tree命令查看生成的根文件系统。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh/images$ tree -L 1 ubuntu1604/
ubuntu1604/
├── bin
├── boot
├── dev
├── etc
├── home
├── lib
├── lib64
├── media
├── mnt
├── old_root
├── opt
├── proc
├── root
├── run
├── sbin
├── srv
├── sys
├── tmp
├── usr
└── var
20 directories, 0 files</code></pre></div></figure><p>这个根文件系统与Linux系统目录很相近，我们后续的实验将使用该根文件系统。</p><h3 id="3-2-pivot-root">3.2.pivot_root</h3><p>pivot_root命令用于切换根文件系统，其使用方式如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pivot_root new_root put_old</code></pre></div></figure><p>pivot_root将当前进程的根文件系统移至put_old目录并使new_root目录成为新的根文件系统。</p><p>下面我们将通过实验学习pivot_root的使用方法。为了简单，我们在一个新的mount namespace下进行实验。首先，我们创建一个新的mount namespace，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh/images$ sudo unshare --mount /bin/bash
root@kernelnewbies:~/docker.sh/images#</code></pre></div></figure><p>在我们的实验中，我们的根文件系统将挂载在ubuntu1604目录，而老的根文件系统将被移动到ubuntu1604/old_root目录下。我们先创建old_root目录，命令如下：</p><p>root@kernelnewbies:~/docker.sh/images# mkdir -p ubuntu1604/old_root/</p><p>由于pivot_root命令要求老的根目录和新的根目录不能在同一个挂载点下，因此我们通过bind mount将ubuntu1604目录变成一个挂载点。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/docker.sh/images# mount --bind ubuntu1604 ubuntu1604
root@kernelnewbies:~/docker.sh/images# cat /proc/self/mountinfo | grep ubuntu1604
624 382 8:1 /home/phl/docker.sh/images/ubuntu1604 /home/phl/docker.sh/images/ubuntu1604 rw,relatime - ext4 /dev/sda1 rw,errors=remount-ro</code></pre></div></figure><p>准备好切换根文件系统所需要的条件后，我们调用pivot_root切换根文件系统。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/docker.sh/images# cd ubuntu1604/
root@kernelnewbies:~/docker.sh/images/ubuntu1604# pivot_root . old_root/</code></pre></div></figure><p>此时，已完成根文件系统的切换，/proc文件系统也被挪到了<br>/home/phl/docker.sh/images/ubuntu1604/old_root/proc，也就是说当前没有/proc文件系统，因此，我们无法查看挂载点信息，自然也无法执行一些依赖于/proc文件系统的操作。我们需要重新挂载/proc文件系统。命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/docker.sh/images/ubuntu1604# mount -t proc proc /proc</code></pre></div></figure><p>重新挂载/proc文件系统后，我们就可以查看当前的挂载点信息了。通过读取/proc/self/mountinfo文件来查看系统的挂载点信息。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/docker.sh/images/ubuntu1604# cat /proc/self/mountinfo
382 624 8:1 / /old_root rw,relatime - ext4 /dev/sda1 rw,errors=remount-ro
...
624 381 8:1 /home/phl/docker.sh/images/ubuntu1604 / rw,relatime - ext4 /dev/sda1 rw,errors=remount-ro
625 624 0:5 / /proc rw,relatime - proc proc rw</code></pre></div></figure><p>此时的挂载点很多，为了方便查看，此处只保留了一些主要的挂载点信息。这些挂载点信息包括/、/proc、/old_root。/old_root为老的根文件系统，我们需要将其卸载。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/docker.sh/images/ubuntu1604# umount -l /old_root/</code></pre></div></figure><p>卸载掉老的根文件系统后，我们再查看系统的挂载点信息。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/docker.sh/images/ubuntu1604# cat /proc/self/mountinfo
624 381 8:1 /home/phl/docker.sh/images/ubuntu1604 / rw,relatime - ext4 /dev/sda1 rw,errors=remount-ro
625 624 0:5 / /proc rw,relatime - proc proc rw</code></pre></div></figure><p>此时，挂载点信息中只有/、/proc，不再有主机的挂载点信息。</p><h3 id="3-3-docker-sh"><a target="_blank" rel="noopener" href="http://3.3.docker.sh">3.3.docker.sh</a></h3><p>有了以上关于切换根文件系统的知识，我们就可以将切换根文件系统的功能加入到docker.sh中了。切换根文件系统的功能将放在container.sh中，带下划线的行是我们为实现切换根文件系统而新添的代码。修改后的container.sh脚本如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#!/bin/bash

hostname $container

mkdir -p /sys/fs/cgroup/memory/$container
echo $$ &gt; /sys/fs/cgroup/memory/$container/cgroup.procs
echo $memory &gt; /sys/fs/cgroup/memory/$container/memory.limit_in_bytes

mkdir -p images/$image/old_root
mount --bind images/$image images/$image

cd images/$image
pivot_root . ./old_root

mount -t proc proc /proc
umount -l /old_root

exec $program</code></pre></div></figure><p>首先，我们在新的根文件系统目录中创建挂载老的根文件系统的目录。命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mkdir -p images/$image/old_root</code></pre></div></figure><p>然后，我们将新根文件系统目录bind mount成一个挂载点。命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mount --bind images/$image images/$image</code></pre></div></figure><p>然后，我们切换根文件系统。命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cd images/$image
pivot_root . ./old_root</code></pre></div></figure><p>最后，我们重新挂载/proc文件系统，然后卸载掉老的根文件系统。命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mount -t proc proc /proc
umount -l /old_root</code></pre></div></figure><p>现在，<a target="_blank" rel="noopener" href="http://xn--docker-hz8i102ky51eyyp.sh">我们运行docker.sh</a>，并查看当前的发行版信息。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ sudo ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
root@dreamland:/# cat /etc/issue
Ubuntu 16.04 LTS \n \l</code></pre></div></figure><p>从结果我们可以看出，读出的发行版信息是Ubuntu 16.04 LTS \n \l，而非主机的Ubuntu 18.04.3 LTS \n \l。这说明当前使用的根文件系统确实是ubuntu16.04目录下的根文件系统，而非主机的根文件系统。</p><p>我们再查看一下当前的挂载点信息，看看是否只有/与/proc。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@dreamland:/# cat /proc/self/mountinfo
625 381 8:1 /home/phl/docker.sh/images/ubuntu1604 / rw,relatime - ext4 /dev/sda1 rw,errors=remount-ro
626 625 0:52 / /proc rw,relatime - proc proc rw</code></pre></div></figure><p>从结果我们可看出，当前挂载点信息中只有/、/proc，不再有主机的挂载点信息。</p><p>通过根文件系统，我们实现了在容器中虚拟出与主机不一样的操作系统的功能。</p><h2 id="4-联合加载">4.联合加载</h2><h3 id="4-1-联合加载简介">4.1.联合加载简介</h3><p>联合加载指的是一次同时加载多个文件系统，但是在外面看起来只能看到 一个文件系统。联合加载会将各层文件系统叠加到一起，这样最终的文件系统会 包含所有底层的文件和目录。</p><p>联合加载的多个文件系统中有一个是可读写文件系统，称为读写层，其他文件系统是只读的，称为只读层。当联合加载的文件系统发生变化时，这些变化都应用到这个读写层。比如，如果想修改一个文件，这个文件首先会从只读层复制到读写层。原只读层中的文件依然存在，但是被读写层中的该文件副本所隐藏。我们以后读写该文件时，都是读写的该文件在读写层中的副本。这种机制被称为 写时复制。</p><p><a target="_blank" rel="noopener" href="http://xn--docker-917i16bq4qp7y1gq013c6xh.sh">我们之前实现的docker.sh</a>，有一个很大的缺陷。那就是，如果使用相同的根文件系统同时启动多个容器的实例，那么，这些容器实例使用的根文件系统位于同一个目录。我们在不同的容器实例对根文件系统所作的修改，这些容器彼此之间都可以看到，甚至一个容器可以覆覆盖另一个容器所作的修改。同时，容器实例退出时，对根文件系统所作的修改也直接作用于其所使用的根文件系统。当我们使用该根文件系统再次启动容器实例时，新启动的容器实例也可以看到以前的这些修改。例如，我们用ubuntu1604根文件系统启动两个容器实例，命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ sudo ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
phl@kernelnewbies:~/docker.sh$ sudo ./docker.sh -c run -m 100M -C dreamland2 -I ubuntu1604 -V data1 -P /bin/bash</code></pre></div></figure><p>这两个容器实例对根文件系统做的修改彼此都可以看到。容器实例退出时，这些修改也被保存了下来，当用ubuntu1604根文件系统启动新的容器实例时，新实例也可看到以前实例所做的修改。</p><p>如果容器使用的根文件系统是一个联合加载的文件系统，原先的根文件系统作为一个只读层，再添加一个读写层，那么，在容器内所作的修改都将只作用于读写层。为了区分，我们以后称ubuntu1604目录下的根文件系统为镜像。而我们可以为每一个容器实例指定一个唯一的读写层目录，这样的话，多个容器实例就可以使用同一个镜像，容器内所作的修改不会影响彼此，也不会影响到以后启动的容器实例。例如：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ sudo ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
phl@kernelnewbies:~/docker.sh$ sudo ./docker.sh -c run -m 100M -C dreamland2 -I ubuntu1604 -V data1 -P /bin/bash</code></pre></div></figure><p>我们使用ubuntu1604镜像启动了两个容器示例，并在容器实例里进行读写操作。这两个容器实例的读写层目录是不一样的，在容器实例中所作的修改只作用于各自的读写层，彼此之间不会影响，当然更不会影响到后续启动的容器实例。</p><h3 id="4-2-AUFS">4.2. AUFS</h3><p>AUFS是一个实现了联合加载功能的文件系统。我们将采用AUFS实现docker.sh中的联合加载功能。</p><p>下面，我们将通过实验演示一下AUFS文件系统的用法。首先，我们准备需要用到的目录及文件。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ mkdir aufs
phl@kernelnewbies:~$ cd aufs/
phl@kernelnewbies:~/aufs$ mkdir rw r1 r2 union
phl@kernelnewbies:~/aufs$ echo hello r1 &gt; r1/hellor1.txt
phl@kernelnewbies:~/aufs$ echo hello r2 &gt; r2/hellor2.txt
phl@kernelnewbies:~/aufs$ echo hello rw &gt; rw/hellorw.txt</code></pre></div></figure><p>下表列出了各个目录的作用。列表如下：</p><ul><li>rw为aufs文件系统的读写层目录</li><li>r1为aufs文件系统的只读层目录</li><li>r2为aufs文件系统的只读层目录</li><li>union为挂载点，联合加载的aufs文件系统挂载于此目录</li></ul><p>下面我们将rw、r1、r2联合加载到union目录。命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/aufs$ sudo mount -t aufs -o dirs=rw:r1:r2 none union</code></pre></div></figure><ul><li>-t aufs表示要挂载的文件系统类型为AUFS</li><li>-o dirs=rw:r1:r2表示要将哪些目录加载到afus文件系统中，多个目录之间以:分隔。目录列表中的第一个目录表示读写层目录</li><li>union表示aufs文件系统要挂载的目录</li></ul><p>挂载好AUFS文件系统后，我们进入该文件系统，查看其内容。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/aufs$ cd union/
phl@kernelnewbies:~/aufs/union$ ls
hellor1.txt hellor2.txt hellorw.txt</code></pre></div></figure><p>从输出结果来看，rw、r1、r2目录下的内容全部出现在了AUFS文件系统中，该文件系统由rw、r1、r2目录叠加而成。</p><p>然后，我们修改这些文件，看看原始的rw、r1、r2目录下的文件是否更改。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/aufs/union$ echo hello to r1 from union &gt; hellor1.txt
phl@kernelnewbies:~/aufs/union$ echo hello to r2 from union &gt; hellor2.txt
phl@kernelnewbies:~/aufs/union$ echo hello to rw from union &gt; hellorw.txt</code></pre></div></figure><p>我们返回到aufs目录，直接查看aufs目录下的内容。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/aufs$ tree .
.
├── r1
│   └── hellor1.txt
├── r2
│   └── hellor2.txt
├── rw
│   ├── hellor1.txt
│   ├── hellor2.txt
│   └── hellorw.txt
└── union
    ├── hellor1.txt
    ├── hellor2.txt
    └── hellorw.txt

4 directories, 8 files</code></pre></div></figure><p>从输出结果我们可以看到，我们修改的hellor1.txt和hellor2.txt文件分别被拷贝了一份放在读写层目录rw中。我们查看一下这些文件的内容，命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/aufs$ cat r1/hellor1.txt
hello r1
phl@kernelnewbies:~/aufs$ cat r2/hellor2.txt
hello r2
phl@kernelnewbies:~/aufs$ cat rw/hellor1.txt
hello to r1 from union
phl@kernelnewbies:~/aufs$ cat rw/hellor2.txt
hello to r2 from union
phl@kernelnewbies:~/aufs$ cat rw/hellorw.txt
hello to rw from union</code></pre></div></figure><p>从输出结果我们看到，用户修改只读层r1、r2中的文件时，这些文件被复制到了读写层，我们修改的是读写层的副本，原只读层中的文件没有变化。用户修改读写层rw中的文件时，修改直接作用于这些文件本身。</p><h3 id="4-3-docker-sh"><a target="_blank" rel="noopener" href="http://4.3.docker.sh">4.3.docker.sh</a></h3><p>在继续之前，我们需要将上一章在ubuntu1604根文件系统中创建的old_root目录删除掉，以保证该根文件系统跟刚制作好时一样。命令及结果如下：</p><p>phl@kernelnewbies:~/docker.sh$ sudo rm -rf images/ubuntu1604/old_root</p><p>有了以上关于联合加载的介绍，我们就可以将联合加载功能加入到docker.sh中了。联合加载功能将放在container.sh脚本中，带下划线的行是我们为实现联合加载功能而新添的代码。修改后的container.sh如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#!/bin/bash

hostname $container

mkdir -p /sys/fs/cgroup/memory/$container
echo $$ &gt; /sys/fs/cgroup/memory/$container/cgroup.procs
echo $memory &gt; /sys/fs/cgroup/memory/$container/memory.limit_in_bytes

mkdir -p $container/rwlayer
mount -t aufs -o dirs=$container/rwlayer:./images/$image none $container

mkdir -p $container/old_root
cd $container
pivot_root . ./old_root

mount -t proc proc /proc
umount -l /old_root

exec $program</code></pre></div></figure><p>首先，我们根据容器的名字创建联合加载需要的读写层目录及文件系统挂载目录。命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mkdir -p $container/rwlayer</code></pre></div></figure><p>假如我们传递的容器的名字为dreamland，将创建以下目录：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ tree dreamland/
dreamland/
└── rwlayer</code></pre></div></figure><p>其中dreamland/rwlayer目录为创建的AUFS文件系统的读写层，dreamland目录为AUFS文件系统的挂载点。</p><p>然后我们将镜像目录、读写层目录联合加载到挂载点目录。命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mount -t aufs -o dirs=$container/rwlayer:./images/$image none $container</code></pre></div></figure><p>假如容器名字为dreamland，使用的镜像为ubuntu1604根文件系统，dreamland/rwlayer、images/ubuntu1604将被联合加载的dreamland目录。其中，dreamland/rwlayer为AUFS文件系统的读写层，images/ubuntu1604为AUFS文件系统的只读层。</p><p>之前我们将老的根文件系统挪到了rootfs/old_root，rootfs代表一个具体的镜像目录。创建old_root目录时直接修改了该镜像。下面我们将老的根文件系统的挂载点目录放在AUFS文件系统中，并将老的根文件系统挪到此处。命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mkdir -p $container/old_root
cd $container
pivot_root . ./old_root</code></pre></div></figure><p>此时，$container目录本身就是一个挂载点，挂载了AUFS文件系统。因此下面的代码就被移除了：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mount --bind images/$image images/$image</code></pre></div></figure><p>现在，<a target="_blank" rel="noopener" href="http://xn--docker-hz8i102ky51eyyp.sh">我们运行docker.sh</a>，并在/root下创建一个文件。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ sudo ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
root@dreamland:/# cd /root
root@dreamland:/root# ls
root@dreamland:/root# cat /etc/issue &gt; hello.txt
root@dreamland:/root# cat hello.txt
Ubuntu 16.04 LTS \n \l</code></pre></div></figure><p>启动一个新的Shell窗口，查看一下该容器使用的AUFS文件系统。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ sudo tree dreamland/
dreamland/
└── rwlayer
    ├── old_root
    └── root
        └── hello.txt

2 directories, 1 file</code></pre></div></figure><p>从结果我们可以看到，我们新建的文件及创建的老根文件系统的挂载点目录都出现在了读写层。我们再查看一下新创建的文件。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ sudo cat dreamland/rwlayer/root/hello.txt
Ubuntu 16.04 LTS \n \l</code></pre></div></figure><p>文件内容是Ubuntu 16.04的发行版信息。</p><p>通过联合加载，我们实现了在容器中的读写不会影响使用的镜像。这样使用ubuntu1604镜像创建多个容器时，彼此之间就不会相互影响了。</p><h2 id="5-卷">5.卷</h2><h3 id="5-1-卷简介">5.1.卷简介</h3><p>卷是容器内的一个目录，这个目录可以绕过联合文件系统，提供数据共享（容器所使用的的联合文件系统不应该被主机或其他容器访问）与数据持久化的功能。</p><p>举个例子，假如容器有个目录为/data的卷，我们向这个卷写入的内容不会出现在联合文件系统的读写层，而是直接出现在这个目录里。主机与其他容器也可以访问该目录，从而达到数据共享与数据持久化的目的。</p><p>卷位于联合文件系统中，通常来说写入该目录的内容会被写入容器的读写层中，那么怎样才能是写入卷的目录直接出现在该目录中，而不是容器读写层呢？其实方法很简单，只要我们将该目录变成一个挂载点就行，变成挂载点后，这个目录中的内容就不属于联合文件系统了，写入该目录的内容自然会保存在挂载到该挂载点的设备中。</p><h3 id="5-2-docker-sh">5.2 <a target="_blank" rel="noopener" href="http://docker.sh">docker.sh</a></h3><p>有了以上关于卷的介绍，我们就可以将卷功能加入到docker.sh中了。卷功能将放在container.sh脚本中，带下划线的行是我们为实现卷功能而新添的代码。修改后的container.sh脚本如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#!/bin/bash

hostname $container

mkdir -p /sys/fs/cgroup/memory/$container
echo $$ &gt; /sys/fs/cgroup/memory/$container/cgroup.procs
echo $memory &gt; /sys/fs/cgroup/memory/$container/memory.limit_in_bytes

mkdir -p $container/rwlayer
mount -t aufs -o dirs=$container/rwlayer:./images/$image none $container

mkdir -p $volume
mkdir -p $container/$volume
mount --bind $volume $container/$volume

mkdir -p $container/old_root
cd $container
pivot_root . ./old_root

mount -t proc proc /proc
umount -l /old_root

exec $program</code></pre></div></figure><p>首先，我们根据卷的名字创建主机卷目录，我们在容器内部对卷的修改，都将作用于此目录。命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mkdir -p $volume</code></pre></div></figure><p>然后，我们在容器内部创建同名卷目录，该目录本身会出现在容器的读写层中，因为该目录是在AUFS文件系统中创建的。因为<mjx-container class="MathJax" jax="SVG" style="direction:ltr;position:relative"><svg style="overflow:visible;min-height:1px;min-width:1px;vertical-align:-.566ex" xmlns="http://www.w3.org/2000/svg" width="62.828ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 27770 1000" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z" style="stroke-width:3"></path></g><g data-mml-node="mi" transform="translate(433,0)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z" style="stroke-width:3"></path></g><g data-mml-node="mi" transform="translate(918,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z" style="stroke-width:3"></path></g><g data-mml-node="mi" transform="translate(1518,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z" style="stroke-width:3"></path></g><g data-mml-node="mi" transform="translate(1879,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z" style="stroke-width:3"></path></g><g data-mml-node="mi" transform="translate(2408,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z" style="stroke-width:3"></path></g><g data-mml-node="mi" transform="translate(2753,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z" style="stroke-width:3"></path></g><g data-mml-node="mi" transform="translate(3353,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z" style="stroke-width:3"></path></g><g data-mml-node="mi" transform="translate(3819,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z" style="stroke-width:3"></path></g><g data-mml-node="mi" transform="translate(4270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">目</text></g><g data-mml-node="mi" transform="translate(5270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">录</text></g><g data-mml-node="mi" transform="translate(6270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">为</text></g><g data-mml-node="mi" transform="translate(7270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">容</text></g><g data-mml-node="mi" transform="translate(8270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">器</text></g><g data-mml-node="mi" transform="translate(9270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">的</text></g><g data-mml-node="mi" transform="translate(10270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">根</text></g><g data-mml-node="mi" transform="translate(11270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">目</text></g><g data-mml-node="mi" transform="translate(12270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">录</text></g><g data-mml-node="mi" transform="translate(13270,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mi" transform="translate(14270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">所</text></g><g data-mml-node="mi" transform="translate(15270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">以</text></g><g data-mml-node="mi" transform="translate(16270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">容</text></g><g data-mml-node="mi" transform="translate(17270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">器</text></g><g data-mml-node="mi" transform="translate(18270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">内</text></g><g data-mml-node="mi" transform="translate(19270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">部</text></g><g data-mml-node="mi" transform="translate(20270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">卷</text></g><g data-mml-node="mi" transform="translate(21270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">目</text></g><g data-mml-node="mi" transform="translate(22270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">录</text></g><g data-mml-node="mi" transform="translate(23270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">的</text></g><g data-mml-node="mi" transform="translate(24270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">路</text></g><g data-mml-node="mi" transform="translate(25270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">径</text></g><g data-mml-node="mi" transform="translate(26270,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">为</text></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(27270,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z" style="stroke-width:3"></path></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline" style="top:0;left:0;clip:rect(1px,1px,1px,1px);-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;position:absolute;padding:1px 0 0 0;border:0;display:block;width:auto;overflow:hidden"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">目</mi><mi mathvariant="normal">录</mi><mi mathvariant="normal">为</mi><mi mathvariant="normal">容</mi><mi mathvariant="normal">器</mi><mi mathvariant="normal">的</mi><mi mathvariant="normal">根</mi><mi mathvariant="normal">目</mi><mi mathvariant="normal">录</mi><mi>，</mi><mi mathvariant="normal">所</mi><mi mathvariant="normal">以</mi><mi mathvariant="normal">容</mi><mi mathvariant="normal">器</mi><mi mathvariant="normal">内</mi><mi mathvariant="normal">部</mi><mi mathvariant="normal">卷</mi><mi mathvariant="normal">目</mi><mi mathvariant="normal">录</mi><mi mathvariant="normal">的</mi><mi mathvariant="normal">路</mi><mi mathvariant="normal">径</mi><mi mathvariant="normal">为</mi><mrow data-mjx-texclass="ORD"><mo>/</mo></mrow></math></mjx-assistive-mml></mjx-container>volume。命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mkdir -p $container/$volume</code></pre></div></figure><p>将主机上的卷目录bind mount到容器内部的卷目录上，这样容器内部对卷目录的修改，都将作用于主机卷目录。命令如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mount --bind $volume $container/$volume</code></pre></div></figure><p>现在，<a target="_blank" rel="noopener" href="http://xn--docker-hz8i102ky51eyyp.sh">我们运行docker.sh</a>，并在卷目录（/data1）中创建一个文件。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ sudo ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
root@dreamland:/# cd /data1
root@dreamland:/data1# echo "hello to data1 volume from ubuntu16.04" &gt;&gt; hello.txt</code></pre></div></figure><p>启动一个新的Shell窗口，查看一下该容器使用的AUFS文件系统中的内容。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ sudo tree dreamland/
dreamland/
└── rwlayer
    ├── data1
    ├── old_root
    └── root
        └── hello.txt

4 directories, 1 file</code></pre></div></figure><p>从结果我们可以看到，我们使用的卷目录被创建在了容器的读写层，但是我们在卷目录中新建的文件却没有出现在读写层中。</p><p>我们再来查看一下主机卷目录的内容。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ sudo tree data1/
data1/
└── hello.txt

0 directories, 1 file</code></pre></div></figure><p>从结果我们可以看到，在容器内部对卷目录的修改直接作用在了主机上的卷目录。我们再来查看一下主机卷目录下hello.txt中的内容。命令及结果如下：</p><figure><div class="code-area"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ sudo cat data1/hello.txt
hello to data1 volume from ubuntu16.04</code></pre></div></figure><p>从结果我们可以看到，该文件的内容与我们在容器内部写入hello.txt的内容一致。</p><p>通过卷目录，我们实现了容器之间数据共享与数据持久化的功能。</p><h2 id="6-后记">6.后记</h2><p>至此，我们通过一系列的实验对docker的底层技术有了一个感性的认识。我们在使用docker时，也能够对其是如何运作的有了一个大致的了解。当然，这对于掌握docker技术来说还远远不够，有很多知识我们没有涉及，例如user namespace、容器安全、其他的CGroups、虚拟网络等。</p><p>编辑整理 <a target="_blank" rel="noopener" href="https://www.toutiao.com/i6890898988879315468/?tt_from=weixin&amp;utm_campaign=client_share&amp;wxshare_count=1&amp;timestamp=1647576105&amp;app=news_article&amp;utm_source=weixin&amp;utm_medium=toutiao_android&amp;use_new_style=1&amp;req_id=202203181201440101511900790A2CBE46&amp;share_token=b2d9351e-4cb1-4a25-ae82-f70543ce2a3b&amp;group_id=6890898988879315468">ScratchLab</a></p></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者: </i></span><span class="reprint-info"><a href="https://blog.17lai.site" rel="external nofollow noreferrer">夜法之书</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接: </i></span><span class="reprint-info"><a href="https://blog.17lai.site/posts/90e60aac/">https://blog.17lai.site/posts/90e60aac/</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明: </i></span><span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.17lai.site" target="_blank">夜法之书</a> !</span></div></div><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/linux/"><span class="chip bg-color">linux</span> </a><a href="/tags/docker/"><span class="chip bg-color">docker</span> </a><a href="/tags/shell/"><span class="chip bg-color">shell</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div></div></div></div><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close" href="javascript:;" aria-label="打赏作者"><i class="fa fa-times-circle"></i></a><p class="reward-title">码字辛苦，打赏作者！</p><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="/medias_webp/reward/alipay.webp" srcset="/medias_webp/loading2.svg" loading="lazy" lazyload loading="lazy" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="/medias_webp/reward/wechat.webp" srcset="/medias_webp/loading2.svg" loading="lazy" lazyload loading="lazy" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><div class="webpush-dingyue" style="margin:10px 0;text-align:center"><div id="webpushr-subscription-button" data-size="small" data-button-text="订阅博文" data-subscriber-count-text="个用户已订阅" data-background-color="#6295d0"></div></div><script>$((function(){$(".reward-tabs").tabs({event:"mouseover"})}))</script></div></div><div id="comments" lazyload><div class="card waline-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="waline" class="card-content" style="display:grid"></div></div><div id="to_comment" class="comment-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="javascript:;" title="直达评论"><i class="fas fa-comments"></i></a></div></div><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/posts/3b296307/"><div class="card-image card-image-V"><div class="box-content"><p class="title">阅读全文</p><span class="post" style="width:180px">winrar去广告和破解</span></div><img src="/medias_webp/cover/winrar.webp" srcset="/medias_webp/loading2.svg" loading="lazy" lazyload class="responsive-img" alt="winrar去广告和破解"> <span class="card-title title-V">winrar去广告和破解</span></div></a><div class="card-content article-content"><div class="summary block-with-text">winrar国内版弹窗广告太讨人嫌了，如何去除广告了？本文一步一步教你如何破解winrar并且去除广告。还你一个清爽的使用体验</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2022-03-19 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/tools/" class="post-category">tools</a></span></div></div><div class="card-action article-tags"><a href="/tags/crack/"><span class="chip bg-color">crack</span> </a><a href="/tags/tools/"><span class="chip bg-color">tools</span> </a><a href="/tags/winrar/"><span class="chip bg-color">winrar</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/posts/68d3867d/"><div class="card-image card-image-V"><div class="box-content"><p class="title">阅读全文</p><span class="post" style="width:180px">node 项目从构建到使用 jenkins + docker + nginx + mysql + redis 自动化部署</span></div><img src="/medias_webp/cover/web.webp" srcset="/medias_webp/loading2.svg" loading="lazy" lazyload class="responsive-img" alt="node 项目从构建到使用 jenkins + docker + nginx + mysql + redis 自动化部署"> <span class="card-title title-V">node 项目从构建到使用 jenkins + docker + nginx + mysql + redis 自动化部署</span></div></a><div class="card-content article-content"><div class="summary block-with-text">node 项目从构建到使用 jenkins + docker + nginx + mysql + redis CI/CD自动化部署全过程详解，一步一步教你完成自动化！</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2022-03-16 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/web/" class="post-category">web</a></span></div></div><div class="card-action article-tags"><a href="/tags/web/"><span class="chip bg-color">web</span> </a><a href="/tags/docker/"><span class="chip bg-color">docker</span> </a><a href="/tags/ci-cd/"><span class="chip bg-color">ci/cd</span> </a><a href="/tags/node/"><span class="chip bg-color">node</span> </a><a href="/tags/jenkins/"><span class="chip bg-color">jenkins</span></a></div></div></div></div></article></div></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget card"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color" href="javascript:;" title="显示/隐藏目录"><i class="fas fa-list-ul"></i></a></div></main><footer class="page-footer bg-color"><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2020-2022</span> <a href="/about" target="_blank">夜法之书</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br>&nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">478k</span> <span id="busuanzi_container_site_pv">&nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp; <span id="busuanzi_value_site_pv" class="white-color"></span> </span><span id="busuanzi_container_site_uv">&nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp; <span id="busuanzi_value_site_uv" class="white-color"></span> </span><span id="waline_container_site_pv" style="display:none">&nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp; <span class="waline-pageview-count" data-path="/" class="white-color"></span></span><br><span id="sitetime">Loading ...</span><script>var calcSiteTime=function(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,i=e.getDate(),a=e.getHours(),r=e.getMinutes(),s=e.getSeconds(),o=Date.UTC("2020","6","28","0","0","0"),g=Date.UTC(t,n,i,a,r,s)-o,d=Math.floor(g/31536e6),m=Math.floor(g/864e5-365*d);if("2020"===String(t)){document.getElementById("year").innerHTML=t;var l="This site has been running for "+m+" days";l="本站已运行 "+m+" 天",document.getElementById("sitetime").innerHTML=l}else{document.getElementById("year").innerHTML="2020 - "+t;var c="This site has been running for "+d+" years and "+m+" days";c="本站已运行 "+d+" 年 "+m+" 天",document.getElementById("sitetime").innerHTML=c}};calcSiteTime()</script><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/appotry" class="tooltipped" target="_blank" title="访问我的GitHub" aria-label="访问我的GitHub" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github fa-fw"></i> </a><a href="https://hub.docker.com/u/bloodstar" class="tooltipped" target="_blank" title="访问我的DockerHub" aria-label="访问我的DockerHub" data-tooltip="访问我的DockerHub" data-position="top" data-delay="50"><i class="fab fa-docker fa-fw"></i> </a><a href="mailto:andycrusoe@gmail.com" class="tooltipped" target="_blank" title="邮件联系我" aria-label="邮件联系我" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open fa-fw"></i> </a><a href="https://twitter.com/firekingden" class="tooltipped" target="_blank" title="关注我的Twitter: https://twitter.com/firekingden" aria-label="关注我的Twitter" data-tooltip="关注我的Twitter: https://twitter.com/firekingden" data-position="top" data-delay="50"><i class="fab fa-twitter fa-fw"></i> </a><a href="/atom.xml" class="tooltipped" target="_blank" title="RSS 订阅" aria-label="RSS 订阅" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss fa-fw"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span><div class="search-input-container"><input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><a class="close modal-close" href="javascript:;" title="关闭搜索"><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></a></div><div id="searchResult"></div></div></div><script type="text/javascript">var searchFunc=function(t,e,r){"use strict";$.ajax({url:t,dataType:"xml",success:function(t){var n=$("entry",t).map((function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}})).get(),a=document.getElementById(e),s=document.getElementById(r);a.addEventListener("input",(function(){var t='<ul class="search-result-list">',e=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length<=0||(n.forEach((function(r){var n=!0,a=r.title.trim().toLowerCase(),s=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),c=r.url;c=0===c.indexOf("/")?r.url:"/"+c;var i=-1,l=-1,u=-1;if(""!==a&&""!==s&&e.forEach((function(t,e){i=a.indexOf(t),l=s.indexOf(t),i<0&&l<0?n=!1:(l<0&&(l=0),0===e&&(u=l))})),n){t+="<li><a href='"+c+"' class='search-result-title'>"+a+"</a>";var o=r.content.trim().replace(/<[^>]+>/g,"");if(u>=0){var h=u-20,f=u+80;h<0&&(h=0),0===h&&(f=100),f>o.length&&(f=o.length);var m=o.substr(h,f);e.forEach((function(t){var e=new RegExp(t,"gi");m=m.replace(e,'<em class="search-keyword">'+t+"</em>")})),t+='<p class="search-result">'+m+"...</p>"}t+="</li>"}})),t+="</ul>",s.innerHTML=t)}))}})};function startXMLSearch(){searchFunc("/search.xml","searchInput","searchResult")}</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!" title="回到顶部"><i class="fas fa-arrow-up"></i></a></div><script src="/libs/materialize/materialize.js"></script><script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.min.js"></script><script src="/js/matery.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script type="module" async>var pagePath=window.location.pathname.replace(/\/$/,"")+"/";import{pageviewCount}from"https://cdn.jsdelivr.net/npm/@waline/client@v2/dist/pageview.min.mjs";function isOwnEmpty(e){for(var n in e)if(e.hasOwnProperty(n))return!1;return!0}function upDatePageview(){const e=pageviewCount({serverURL:"https://waline.17lai.site",path:pagePath});setTimeout(()=>e(),2e3);document.getElementById("waline_container_site_pv");var n=document.getElementById("waline_container_page_pv");n?1!=isOwnEmpty(n.style)?(n.style.display="inline",console.log("[waline]update pageview count!")):console.log("[waline]ewacpv.style null!"):console.log("[waline]home page!")}function delayupDatePageview(){setTimeout((function(){upDatePageview()}),3e3),console.log("[waline]delay update comment count!")}delayupDatePageview()</script><script type="module" async>var pagePath=window.location.pathname.replace(/\/$/,"")+"/";import{commentCount}from"https://cdn.jsdelivr.net/npm/@waline/client@v2/dist/comment.min.mjs";function upDateComment(){const e=commentCount({serverURL:"https://waline.17lai.site",path:pagePath});setTimeout(()=>e(),3e3);try{wa_ccc="waline_container_comment_count",document.getElementById(wa_ccc).style.display="inline"}catch(e){console.log("[waline-count][Error] err")}console.log("[waline]update comment count!")}function delayUpDateComment(){setTimeout((function(){upDateComment()}),3e3),console.log("[waline]delay update comment count!")}delayUpDateComment()</script><script src="https://cdn.jsdelivr.net/npm/scrollprogress@3.0.2/dist/scrollProgress.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery-all.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery-ui@1.13.2/dist/jquery-ui.min.js"></script><div class="waifu"><div class="waifu-tips"></div><canvas id="live2d" class="live2d"></canvas><div class="waifu-tool"><span class="fa fa-lg fa-home"></span> <span class="fa fa-lg fa-comment"></span> <span class="fa fa-lg fa-user-circle"></span> <span class="fa fa-lg fa-street-view"></span> <span class="fa fa-lg fa-camera-retro"></span> <span class="fa fa-lg fa-info-circle"></span> <span class="fa fa-lg fa-times-circle"></span></div></div><script async src="https://cdn.jsdelivr.net/npm/instant.page@5.1.1/instantpage.js" type="module"></script><script type="text/javascript">localStorage.getItem("viewCount")?(localStorage.viewCount=Number(localStorage.viewCount)+1,console.log("Welcome to visited again!")):(localStorage.setItem("viewCount","1"),console.log("Welcome! New Reader!"))</script><script type="text/javascript">var themeStorage=window.localStorage;window.localStorage?(console.log("设定waline count title"),themeStorage.setItem("title","夜法之书")):console.log("浏览器不支持localstorage")</script><script src="https://cdn.jsdelivr.net/npm/jquery-ui@1.13.2/dist/jquery-ui.min.js"></script><script type="text/javascript">var windowWidth=$(window).width();if(windowWidth>1024&&Number(localStorage.viewCount)>1)try{$.ajax({url:"/libs/live2d/waifu-tips.js",dataType:"script",cache:!0,success:function(){$.ajax({url:"/libs/live2d/live2d.js",dataType:"script",cache:!0,success:function(){live2d_settings.modelId=2,live2d_settings.modelTexturesId=17,live2d_settings.modelStorage=!0,live2d_settings.canCloseLive2d=!0,live2d_settings.canTurnToHomePage=!1,live2d_settings.waifuDraggable="axis-x",live2d_settings.waifuDraggableRevert=!0,initModel("/libs/live2d/waifu-tips.json")}})}})}catch(e){console.log("[Live2d][Error] JQuery is not defined.")}</script><script>var pagePath=window.location.pathname.replace(/\/$/,"")+"/";function initWaline(){console.log("[WALINE]init waline"),Waline.init({el:"#waline",locale:{lang:"zh-cn",nick:"🧊 昵称",mail:"📧 邮箱",link:"🔗 网址",placeholder:"🤣一起来玩，留下你的足迹吧~。评论支持邮箱回复通知！📧\r\n 🚀支持注册登录，并新增支持Github登录(⊙o⊙)！💖\r\n 💣请文明评论哦禁止恶意评论🈲\r\n ⚠️公开网络空间，请不要发表任何包含个人或其他人的隐私信息⛔",sofa:"🌌 来发评论吧~",submit:"发送留言",comment:"评论",more:"读取更多评论",uploading:"正在上传",login:"登录",admin:"博主",word:"个字",nickError:"昵称不能少於 3 个字符",mailError:"请填写正确的电子邮箱",wordHint:"评论字数应在 $0 到 $1 字之间！\\n目前字数：$2",seconds:"秒前",minutes:"分钟前",hours:"小时前",days:"天前",now:"就在刚刚",reply:"回复",canaleReply:"取消回复",emoji:"表情",uploadImage:"上传图片",logout:"退出登录",preview:"预览",level0:"炼体",level1:"炼气",level2:"筑基",level3:"金丹",level4:"元婴",level5:"化神",reactionTitle:"码字辛苦！客官不评论一下么？",reaction0:"赞一个",reaction1:"踩一下",reaction2:"有点酷",reaction3:"看不懂",reaction4:"啥玩意",reaction5:"想睡觉"},serverURL:"https://waline.17lai.site",path:pagePath,avatar:"mp",emoji:["//cdn.jsdelivr.net/gh/walinejs/emojis@latest/weibo"],lang:"zh-CN",dark:'html[data-user-color-scheme="dark"]',login:"enable",wordLimit:"1000",pageSize:"10",highlighter:"hanabi",pageview:!1,comment:!0,reaction:!0,imageUploader:!1,meta:["nick","mail","link"],recaptchaV3Key:"6LeUY0MiAAAAABNBvi6m4PcCtKkv_W6x-_YhTb6n",requiredMeta:["nick","mail"]});{function e(){const e=Waline.commentCount({serverURL:"https://waline.17lai.site",path:pagePath});setTimeout(()=>e(),2e3);try{wa_ccc="waline_container_comment_count",document.getElementById(wa_ccc).style.display="inline"}catch(e){console.log("[waline-count][Error] err")}console.log("[waline]update comment count!")}function n(){setTimeout((function(){e()}),5e3),console.log("[waline]delay update comment count!")}var i=document.body.getElementsByClassName("wl-btn primary");void 0!==i[0]?(void 0!==window.addEventListener?i[0].addEventListener("click",n,!1):i[0].attachEvent("onclick",n),e()):console.log("[waline]没有开启waline!")}AOS.refresh(),progressBarInit()}function loadWaline(){try{$.ajax({url:"https://cdn.jsdelivr.net/npm/@waline/client@v2/dist/waline.min.css",dataType:"text/css",cache:!0,success:function(e){$("head").append("<style>"+e+"</style>")},error:function(e){console.log(e)}}),$.ajax({url:"https://cdn.jsdelivr.net/npm/@waline/client@v2/dist/waline.min.js",dataType:"script",cache:!0,success:function(){initWaline()}})}catch(e){console.log("[SHARE][Error] JQuery is not defined.")}}var runningOnBrowser="undefined"!=typeof window,isBot=runningOnBrowser&&!("onscroll"in window)||"undefined"!=typeof navigator&&/(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent),supportsIntersectionObserver=runningOnBrowser&&"IntersectionObserver"in window;setTimeout((function(){if(!isBot&&supportsIntersectionObserver){var e=new IntersectionObserver((function(n){n[0].isIntersecting&&(loadWaline(),e.disconnect())}),{threshold:[0]});e.observe(document.getElementById("reprint-statement"))}else loadWaline()}),1)</script><script>AOS.refresh(),progressBarInit()</script><script type="text/javascript">postTimeliness(),inPageScroll()</script><script>var tocSchemaStorageKey=window.location.pathname.replace(/\/$/,"")+"/toc";function setLS(t,e){try{localStorage.setItem(t,e)}catch(t){}}function getLS(t){try{return localStorage.getItem(t)}catch(t){return null}}getLS(tocSchemaStorageKey)||setLS(tocSchemaStorageKey,"show")</script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.18.2/dist/tocbot.min.js"></script><script>$((function(){if($(window).width()<800)return!0;document.documentElement;var e=jQuery("#toc-aside .toc-widget");if(0===e.length||!window.tocbot)return;var t=jQuery("#headNav").height()+10,o=window.location.pathname.replace(/\/$/,"")+"/toc",s=getLS(o);let l=$("#toc-aside"),n=$("#main-content");function i(e){return"show"===s?(console.log("Current page toc: show"),!0):"hide"===s?(console.log("Current page toc: hide"),!1):void console.log("Current page toc: unknow, use default")}var a=e[0].getElementsByClassName("is-active-li");e[0].getElementsByClassName("toc-title");function c(){tocbot.init({tocSelector:"#toc-content",contentSelector:"#articleContent",headingsOffset:-t,scrollSmoothOffset:-t,collapseDepth:Number("0"),scrollSmooth:!0,headingSelector:"h2, h3, h4, h5, h6"}),e.find(".toc-list-item").length>0&&e.css("visibility","visible")}window.onscroll=()=>{e.length>0&&(a.length>0&&a[0].offsetTop>e[0].offsetHeight&&(e[0].scrollTop=a[0].offsetTop-e[0].offsetHeight/2),a.length>0&&e[0].offsetHeight>a[0].offsetHeight&&(e[0].scrollTop=0),a.length>0&&a[0].offsetTop>e[0].offsetHeight&&(e[0].scrollTop=a[0].offsetTop-e[0].offsetHeight/2))},getLS(o),("show"===s?(console.log("Current page toc: show"),l.addClass("expanded").show(),n.addClass("l9"),1):"hide"===s?(console.log("Current page toc: hide"),l.removeClass("expanded").hide(),n.removeClass("l9"),0):void console.log("Current page toc: unknow, use default"))&&c();let d=parseInt(.4*$(window).height()-64),r=$("#toc-aside .toc-widget");$(window).scroll((function(){$(window).scrollTop()>d?r.addClass("toc-fixed"):r.removeClass("toc-fixed")}));let h=function(e,t){let o=$("#"+e);if(0===o.length)return;let s=o.width();s+=s>=450?21:s>=350&&s<450?18:s>=300&&s<350?16:14,$("#"+t).width(s)};h("artDetail","prenext-posts"),$("#floating-toc-btn .btn-floating").click((function(){l.hasClass("expanded")?(l.removeClass("expanded").hide(),n.removeClass("l9"),i(getLS(o))||tocbot.destroy(),setLS(o,"hide")):(i(getLS(o))||c(),setLS(o,"show"),l.addClass("expanded").show(),n.addClass("l9")),h("artDetail","prenext-posts"),AOS.refresh(),progressBarInit()}))}))</script><script>$("#articleContent").on("copy",(function(e){if(void 0!==window.getSelection){var n=window.getSelection();if(!((""+n).length<Number.parseInt("120"))){var t=document.getElementsByTagName("body")[0],o=document.createElement("div");o.style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"!==n.getRangeAt(0).commonAncestorContainer.nodeName&&"CODE"!==n.getRangeAt(0).commonAncestorContainer.nodeName||(o.innerHTML="<pre>"+o.innerHTML+"</pre>");var i=document.location.href;o.innerHTML+='<br />来源: 夜法之书<br />文章作者: 夜法之书<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者所有，任何形式的转载都请注明出处。",n.selectAllChildren(o),window.setTimeout((function(){t.removeChild(o)}),200)}}}))</script><script>function navToReprintStatement(){$("html, body").animate({scrollTop:$("#reprint-statement").offset().top-80},800)}document.addEventListener("copy",(function(t){M.toast({html:'<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>'})}))</script><script>function loadShare(){try{jQuery.ajax({url:"https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js",dataType:"script",cache:!0,success:function(){}})}catch(e){console.log("[SHARE][Error] JQuery is not defined.")}}var runningOnBrowser="undefined"!=typeof window,isBot=runningOnBrowser&&!("onscroll"in window)||"undefined"!=typeof navigator&&/(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent),supportsIntersectionObserver=runningOnBrowser&&"IntersectionObserver"in window;setTimeout((function(){if(!isBot&&supportsIntersectionObserver){var e=new IntersectionObserver((function(n){n[0].isIntersecting&&(loadShare(),e.disconnect())}),{threshold:[0]});e.observe(document.getElementById("article-share"))}else loadShare()}),1)</script><script type="text/javascript">progressBarInit()</script><script async src="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script><script>Matery.plugins.codeWidget()</script><script defer src="/js/img-lazyload.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript><script src="https://cdn.jsdelivr.net/npm/hexo-tag-common-new@0.2.4/js/index.js"></script><script>(function (w, d, s, id) {
            if (typeof (w.webpushr) !== 'undefined') return; w.webpushr = w.webpushr || function () { (w.webpushr.q = w.webpushr.q || []).push(arguments) }; var js, fjs = d.getElementsByTagName(s)[0]; js = d.createElement(s); js.id = id; js.async = 1; js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window, document, 'script', 'webpushr-jssdk'));webpushr('setup', { 'key': 'BDHamjevXR9yPJrttxl80MjCYEwm3CKzwsi3rwMXxq4Lnbzhr2fNQARqXJVhfBn_ucmy9QHixa3qps8eEFXBwmw' });</script></body></html>